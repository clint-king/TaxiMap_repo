<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="
    script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://api.mapbox.com https://cdn.jsdelivr.net;
    frame-src 'self';
    connect-src 'self' ws://localhost:* wss://localhost:* http://localhost:* https://localhost:* https://api.teksimap.co.za https://api.mapbox.com https://events.mapbox.com;
    style-src 'self' 'unsafe-inline' https://api.mapbox.com https://cdnjs.cloudflare.com https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
    img-src 'self' data: blob: https://api.mapbox.com;
">

    <title>Multi-Taxi Path with Mapbox</title>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      integrity="sha512-..."
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/clientStyle.css" />
    <link rel="stylesheet" href="./css/popup.css" />
  </head>
  <body class="has-map-layout">
    <div class="wrapper">
      <!-- Top navigation bar -->
      <nav class="topnav">
        <div class="nav-container">
          <div class="logo">
            <a href="index.html">
              <img src="logo-advanced-white.svg" alt="TeksiMap Logo" class="h-10 w-auto" />
            </a>
          </div>

          <!-- Burger button for mobile -->
          <div class="burger" onclick="toggleMobileMenu()">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
          </div>

          <!-- Navigation links -->
          <div class="nav-links" id="mobileMenu">
            <a href="client.html" onclick="topNavZIndexDecrease()">Find route</a>
            <a href="clientCrowdSource.html" onclick="topNavZIndexDecrease()">Suggest route</a>
            <a href="profile.html" onclick="topNavZIndexDecrease()">Profile</a>
            <a href="help.html" onclick="topNavZIndexDecrease()">Help</a>
          </div>
        </div>
      </nav>
      <!-- Search slider button-->

      <!-- Popup -->
      <div id="popup-container"></div>

      <div class="page-content">
        <button class="searchSlider">
          <i
            class="fa-solid fa-caret-down"
            style="color: #919191; font-size: 20px"
            aria-hidden="true"
          ></i>
        </button>

        <div class="search_container">
          <div class="sourceSearch container">
            <div class="searchRow source">
              <i
                class="fas fa-search"
                style="color: #919191; font-size: 20px"
              ></i>
              <input
                class="search_input source"
                placeholder="Search Starting location"
              />
            </div>

            <ul class="searchList listSource"></ul>
          </div>
          <div class="destinationSearch container">
            <div class="searchRow dest">
              <i
                class="fas fa-search"
                style="color: #919191; font-size: 20px"
              ></i>
              <input
                class="search_input destination"
                placeholder="Search Destination"
              />
            </div>
            <ul class="searchList listDestination"></ul>
          </div>
        </div>

        <!-- External drag handle for mobile -->
        <!-- <div class="drag-handle"></div> -->
        
        <!--Ui section-->
        <div id="ui_container">
          <!--Search-->

          <!-- From and To buttons -->
          <div class="toggleButtons_container">
            <button class="toggleBtn from">From</button>
            <button class="toggleBtn to">To</button>
          </div>

          <!--Route list-->
          <div class="routeList_container">
            <!-- Toggle button -->

            <div class="toggle-container">
              <span class="toggle-label price-off"></span>
              <div class="toggle-button" id="toggle">
                <div class="toggle-circle"></div>
              </div>
              <span class="toggle-label price-on">See Price devision</span>
            </div>

            <div class="cover price">
              <p>Price</p>
            </div>

            <div class="list_container">
              <div class="listSub_container list_right">
                <ul>
                  <!-- <li class="rightPriceRow"><div class="route_circle"></div>Route 1</li> -->
                </ul>
              </div>
              <div class="listSub_container list_left">
                <ul>
                  <!-- <li class="leftPriceRow">R50.00</li> -->
                </ul>
              </div>
            </div>

            <div class="cover total_price">
              <p>Total:</p>
              <p>R0.00</p>
            </div>
          </div>

          <!--Directions -->
          <div class="direction_container">
            <p>Directions :</p>
            <button class="default_direction_button">Default</button>
            <div class="sub_direction_container">
              <!-- <button class="direction_button">DA</button>
              <button class="direction_button">DA</button>
              <button class="direction_button">DA</button>
              <button class="direction_button">DA</button>
              <button class="direction_button">DA</button>
              <button class="direction_button">DA</button>
              <button class="direction_button">DA</button>
              <button class="direction_button">DA</button>
              <button class="direction_button">DA</button> -->
            </div>
          </div>

          <button class="feedbackBtn">Feedback</button>
        </div>
        <!--Context menu-->
        <div class="menu markerConfirmation">
          <p id="title">Marker Confirmation</p>
          <button class="close_button" id="del_close_button">
            <i
              class="fa fa-times"
              style="font-size: 20px; color: rblackd"
              aria-hidden="true"
            ></i>
          </button>
          <div class="markerInformation">
            <p>Do you want to lock-in this location ?</p>
          </div>
          <div class="btnContainer">
            <button class="btn no">No</button>
            <button class="btn yes">Yes</button>
          </div>
        </div>

        <!-- Cancel Context menu -->
        <div class="menu cancelRoute">
          <p id="title">Cancel Route</p>
          <button class="close_button" id="del_close_button">
            <i
              class="fa fa-times"
              style="font-size: 20px; color: rblackd"
              aria-hidden="true"
            ></i>
          </button>
          <div class="Information">
            <p>Do you want to cancel the current route ?</p>
          </div>
          <div class="btnContainer">
            <button class="btn no">No</button>
            <button class="btn yes">Yes</button>
          </div>
        </div>

        <!-- Feedback Modal -->
        <div class="menu feedbackModal">
          <p id="title">Submit Feedback</p>
          <button class="close_button" id="feedback_close_button">
            <i
              class="fa fa-times"
              style="font-size: 20px; color: rblackd"
              aria-hidden="true"
            ></i>
          </button>
          <div class="feedbackForm">
            <form id="feedbackForm">
              <div class="form-group">
                <label for="feedbackType">Feedback Type:</label>
                <select id="feedbackType" name="feedback_type" required>
                  <option value="improvement">Improvement Suggestion</option>
                  <option value="complaint">Complaint</option>
                  <option value="general">General Feedback</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="feedbackSubject">Subject:</label>
                <input type="text" id="feedbackSubject" name="subject" placeholder="Brief description of your feedback" required>
              </div>
              
              <div class="form-group">
                <label for="feedbackMessage">Message:</label>
                <textarea id="feedbackMessage" name="message" placeholder="Please provide detailed feedback..." rows="5" required></textarea>
              </div>
              
              <div class="form-group">
                <label for="feedbackImages">Images (optional):</label>
                <input type="file" id="feedbackImages" name="images" multiple accept="image/*">
                <small>You can upload up to 5 images (max 5MB each)</small>
              </div>
              
              <div class="btnContainer">
                <button type="button" class="btn no" id="cancelFeedback">Cancel</button>
                <button type="submit" class="btn yes">Submit Feedback</button>
              </div>
            </form>
          </div>
        </div>

        <!--Map-->
        <div class="map_container">
          <div id="toggleBtn" class="circle-button">
            <div class="arrow"></div>
          </div>

          <!-- <div id="text-map">
             <button class="close_button" >
            <i
              class="fa fa-times"
              style="font-size: 20px; color: rblackd"
              aria-hidden="true"
            ></i>
          </button>
           <div style="color: red;">ER Start</div>
           <div style="color: #F0F4F7;">>> Midpoint</div>
           <div style="color: #00CED1;">ðŸ›‘ End</div>
          </div> -->

          <div id="map">
            <!--area filter -->
            <div class="areaContainer">
              <p>Highlight clickable radius</p>

              <!-- toggle button -->
              <div class="toggle-container">
                <div class="area toggle-button" id="areatoggle">
                  <div class="area toggle-circle"></div>
                </div>
              </div>
            </div>

            <!--Location indicatiion Markers-->
            <div class="locationsContainer">
              <div class="sourceLocation">
                <i
                  class="fa-solid fa-location-dot sourcePin"
                  style="font-size: 25px; color: #919191"
                ></i>
                <p>Starting</p>
              </div>

              <div class="destLocation">
                <i
                  class="fa-solid fa-location-dot destPin"
                  style="font-size: 25px; color: #919191"
                ></i>
                <p>Ending</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Load popup -->
    <script>
      //popup
      fetch("popup.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("popup-container").innerHTML = html;
        });

      function toggleMobileMenu() {
        const menu = document.getElementById("mobileMenu");
        const isShown = menu.classList.toggle("show");

        if (isShown) {
          topNavZIndexIncrease();
        } else {
          topNavZIndexDecrease();
        }
      }

      //slide
      function attachSearchToggle() {
        searchSliderBtn = document.querySelector(".searchSlider");
        const searchContainer = document.querySelector(".search_container");

        if (searchSliderBtn && !searchSliderBtn.dataset.bound) {
          searchSliderBtn.addEventListener("click", () => {
            searchContainer.classList.toggle("hidden");
          });
          searchSliderBtn.dataset.bound = "true"; // Prevent duplicate bindings
        }
      }

      //moving search container
      function moveSearchContainer() {
        const search = document.querySelector(".search_container");
        const ui = document.getElementById("ui_container");
        const pageContent = document.querySelector(".page-content");

        if (!search || !ui) {
          console.warn("One or both elements not found:", { search, ui });
          return;
        }

        if (window.innerWidth > 768) {
          // Desktop: insert search_container back into ui_container
          if (!ui.contains(search)) {
            ui.insertBefore(search, ui.firstChild); // insert at top of ui_container
            console.log("Inserted in container");
          }
        } else {
          // Mobile: move it out of ui_container to body (or wrapper)
          if (ui.contains(search)) {
            pageContent.insertBefore(search, ui);
            console.log("removed from container");
          }
        }
      }

      //fix textmap

      function textMapHeightAdj() {
        if (window.innerWidth <= 768) {
          const navbar = document.querySelector(".topnav");
          const textmap = document.querySelector("#text-map");
          const height = navbar.offsetHeight;
          if (textmap) textmap.style.top = `${height + 40}px`;
        }
      }

      function topNavZIndexIncrease() {
        const navbar = document.querySelector(".topnav");
        navbar.style.zIndex = "3001";
      }

      function topNavZIndexDecrease() {
        const navbar = document.querySelector(".topnav");
        navbar.style.zIndex = "3";
      }

      // Run once on load
      document.addEventListener("DOMContentLoaded", () => {
        attachSearchToggle();
        moveSearchContainer();

        if (window.innerWidth <= 768) {
          dragHandle();
        }
      });

      // Re-attach on window resize (for dynamic appearance of .searchSlider)
      window.addEventListener("resize", () => {
        moveSearchContainer();
        if (window.innerWidth <= 768) {
          attachSearchToggle();
          textMapHeightAdj();
          dragHandle();
        }

        //ui container state
      });

      function dragHandle() {
        const uiContainer = document.getElementById("ui_container");
        const dragHandle = document.querySelector(".drag-handle");

        let startY = 0;
        let currentY = 0;
        let isDragging = false;

        // Touch events for mobile
        dragHandle.addEventListener("touchstart", (e) => {
          e.preventDefault();
          startY = e.touches[0].clientY;
          isDragging = true;
        });

        dragHandle.addEventListener("touchmove", (e) => {
          if (isDragging) {
            e.preventDefault();
            currentY = e.touches[0].clientY;
          }
        });

        dragHandle.addEventListener("touchend", () => {
          if (isDragging) {
            handleDragEnd();
          }
        });

        // Mouse events for desktop testing
        dragHandle.addEventListener("mousedown", (e) => {
          e.preventDefault();
          startY = e.clientY;
          isDragging = true;
        });

        document.addEventListener("mousemove", (e) => {
          if (isDragging) {
            currentY = e.clientY;
          }
        });

        document.addEventListener("mouseup", () => {
          if (isDragging) {
            handleDragEnd();
          }
        });

        function handleDragEnd() {
          const deltaY = currentY - startY;

          // Get current state
          const isExpanded = uiContainer.classList.contains("expanded");
          const isSemiExpanded = uiContainer.classList.contains("semi-expanded");
          const isCollapsed = uiContainer.classList.contains("collapsed");

          if (deltaY < -10) {
            // Swipe up - expand
            if (isCollapsed) {
              // Collapsed -> Semi-expanded
              uiContainer.classList.remove("collapsed");
              uiContainer.classList.add("semi-expanded");
            } else if (isSemiExpanded) {
              // Semi-expanded -> Expanded
              uiContainer.classList.remove("semi-expanded");
              uiContainer.classList.add("expanded");
            }
          } else if (deltaY > 10) {
            // Swipe down - collapse
            if (isExpanded) {
              // Expanded -> Semi-expanded
              uiContainer.classList.remove("expanded");
              uiContainer.classList.add("semi-expanded");
            } else if (isSemiExpanded) {
              // Semi-expanded -> Collapsed
              uiContainer.classList.remove("semi-expanded");
              uiContainer.classList.add("collapsed");
            }
          }

          startY = 0;
          currentY = 0;
          isDragging = false;
        }
      }
    </script>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsts@2.11.0/dist/jsts.min.js"></script>
    <script type="module" src="./js/logout.js"></script>
    <script type="module" src="./js/client.js"></script>
  </body>
</html>
