import{B as m}from"./AddressSelection-CWIIN_Gi.js";/* empty css               */import{r as B}from"./logout-DBLdyFVo.js";import{a as d}from"./axios-D4YhIzwJ.js";import{g as L,a as k,b as I,c as M,d as D,e as T,f as P,h as $}from"./paymentApi-B8IjspkC.js";document.addEventListener("DOMContentLoaded",()=>{B()});d.defaults.withCredentials=!0;const S=async()=>{try{return(await d.get(`${m}/api/drivers/profile`)).data}catch(a){throw console.error("Error fetching driver profile:",a),a}},_=async()=>{try{return(await d.get(`${m}/api/drivers/documents`)).data}catch(a){throw console.error("Error fetching driver documents:",a),a}},U=async()=>{try{return(await d.get(`${m}/api/drivers/owner/my-drivers`)).data}catch(a){throw console.error("Error fetching owner drivers:",a),a}};d.defaults.withCredentials=!0;const x=async()=>{try{return(await d.get(`${m}/api/owners/profile`)).data}catch(a){throw console.error("Error fetching owner profile:",a),a}},A=async a=>{try{return(await d.put(`${m}/api/owners/profile`,a)).data}catch(e){throw console.error("Error updating owner profile:",e),e}},N=async(a=null,e=null,s=50,t=0)=>{try{const i={limit:s,offset:t};return a&&(i.start_date=a),e&&(i.end_date=e),(await d.get(`${m}/api/owners/revenue`,{params:i})).data}catch(i){throw console.error("Error fetching owner revenue:",i),i}};d.defaults.withCredentials=!0;d.defaults.withCredentials=!0;d.interceptors.response.use(a=>a,a=>{if(a.response&&(a.response.status===401||a.response.status===403)){if(console.log("Session expired detected by interceptor"),!localStorage.getItem("userProfile"))return window.location.href="/pages/authentication/login.html",Promise.reject(a);const s=window.location.pathname;if(!s.includes("login.html")&&!s.includes("signup.html")){localStorage.removeItem("userProfile"),localStorage.removeItem("activityLog");const t=document.getElementById("messageContainer");if(t){const i=document.createElement("div");i.className="message error",i.textContent="Session expired. Redirecting to home page...",t.appendChild(i)}setTimeout(()=>{window.location.href="/index.html"},2e3)}}return Promise.reject(a)});class C{constructor(){this.currentUser=null,this.activityLog=[],this.init()}async init(){await this.loadUserData(),this.setupUserTypeSpecificTabs(),this.setupEventListeners(),this.loadActivityLog(),this.setupTabNavigation(),this.setupPasswordStrength(),this.setupModalEvents(),this.setupMobileMenu(),this.setupBookingsTab()}setupUserTypeSpecificTabs(){if(!this.currentUser)return;const e=this.currentUser.user_type,s=document.querySelectorAll(".driver-only"),t=document.querySelectorAll(".owner-only"),i=document.querySelectorAll(".admin-only");e==="driver"?s.forEach(n=>n.style.display="block"):s.forEach(n=>n.style.display="none"),e==="owner"?t.forEach(n=>n.style.display="block"):t.forEach(n=>n.style.display="none"),e==="admin"?i.forEach(n=>n.style.display="block"):i.forEach(n=>n.style.display="none"),this.setupUserTypeDataLoaders()}setupUserTypeDataLoaders(){var h;const e=(h=this.currentUser)==null?void 0:h.user_type;if(document.getElementById("driver-info")&&e==="driver"&&this.loadDriverInfo(),document.getElementById("driver-documents")&&e==="driver"){const c=document.querySelector('[data-tab="driver-documents"]');c&&c.addEventListener("click",()=>this.loadDriverDocuments())}if(document.getElementById("driver-vehicles")&&e==="driver"){const c=document.querySelector('[data-tab="driver-vehicles"]');c&&c.addEventListener("click",()=>this.loadDriverVehicles())}if(document.getElementById("business-info")&&e==="owner"&&this.loadOwnerProfile(),document.getElementById("owner-vehicles")&&e==="owner"){const c=document.querySelector('[data-tab="owner-vehicles"]');c&&c.addEventListener("click",()=>this.loadOwnerVehicles())}if(document.getElementById("owner-drivers")&&e==="owner"){const c=document.querySelector('[data-tab="owner-drivers"]');c&&c.addEventListener("click",()=>this.loadOwnerDrivers())}if(document.getElementById("owner-revenue")&&e==="owner"){const c=document.querySelector('[data-tab="owner-revenue"]');c&&c.addEventListener("click",()=>this.loadOwnerRevenue())}if(document.getElementById("admin-dashboard")&&e==="admin"){const c=document.querySelector('[data-tab="admin-dashboard"]');c&&c.addEventListener("click",()=>this.loadAdminDashboard())}if(document.getElementById("user-management")&&e==="admin"){const c=document.querySelector('[data-tab="user-management"]');c&&c.addEventListener("click",()=>this.loadUserManagement())}}async loadDriverInfo(){try{const e=await S();if(e.success&&e.driver){const s=e.driver,t=document.getElementById("licenseNumber"),i=document.getElementById("licenseExpiry"),n=document.getElementById("driverStatus"),r=document.getElementById("verificationStatus"),o=document.getElementById("driverRatingDisplay");if(t&&(t.value=s.license_number||""),i&&(i.value=s.license_expiry||""),n&&(n.value=s.status||"pending"),r&&(r.value=s.verification_status||"pending"),o){const l=o.querySelector(".rating-value"),u=o.querySelector(".rating-stars");if(l&&(l.textContent=s.rating?s.rating.toFixed(1):"N/A"),u){const g=Math.round(s.rating||0);u.innerHTML="★".repeat(g)+"☆".repeat(5-g)}}}}catch(e){console.error("Error loading driver info:",e)}}async loadDriverDocuments(){try{const e=await _(),s=document.getElementById("driverDocumentsList");if(!s)return;if(e.success&&e.documents){if(e.documents.length===0){s.innerHTML="<p>No documents uploaded yet.</p>";return}s.innerHTML=e.documents.map(t=>`
                    <div class="document-item">
                        <h4>${t.document_type}</h4>
                        <p>Status: ${t.status}</p>
                        ${t.expiry_date?`<p>Expires: ${new Date(t.expiry_date).toLocaleDateString()}</p>`:""}
                        <img src="${t.image_url}" alt="${t.document_type}" style="max-width: 200px;">
                    </div>
                `).join("")}}catch(e){console.error("Error loading driver documents:",e);const s=document.getElementById("driverDocumentsList");s&&(s.innerHTML="<p>Error loading documents.</p>")}}async loadDriverVehicles(){try{const e=await L(),s=document.getElementById("assignedVehiclesList");if(!s)return;if(e.success&&e.vehicles){if(e.vehicles.length===0){s.innerHTML="<p>No vehicles assigned.</p>";return}s.innerHTML=e.vehicles.map(t=>`
                    <div class="vehicle-card">
                        <h4>${t.make} ${t.model}</h4>
                        <p>Registration: ${t.registration_number}</p>
                        <p>Capacity: ${t.capacity} seats</p>
                        <p>Status: ${t.vehicle_status}</p>
                    </div>
                `).join("")}}catch(e){console.error("Error loading driver vehicles:",e);const s=document.getElementById("assignedVehiclesList");s&&(s.innerHTML="<p>Error loading vehicles.</p>")}}async loadOwnerProfile(){try{const e=await x();if(e.success&&e.owner){const s=e.owner,t=document.getElementById("businessName"),i=document.getElementById("businessType"),n=document.getElementById("businessRegistrationNumber"),r=document.getElementById("taxNumber"),o=document.getElementById("totalVehicles"),l=document.getElementById("totalDrivers"),u=document.getElementById("ownerStatus"),g=document.getElementById("ownerVerificationStatus");t&&(t.value=s.business_name||""),i&&(i.value=s.business_type||"individual"),n&&(n.value=s.business_registration_number||""),r&&(r.value=s.tax_number||""),o&&(o.value=s.total_vehicles||0),l&&(l.value=s.total_drivers||0),u&&(u.value=s.status||"pending"),g&&(g.value=s.verification_status||"pending")}}catch(e){console.error("Error loading owner profile:",e)}}async loadOwnerVehicles(){try{const e=await k(),s=document.getElementById("ownerVehiclesList");if(!s)return;if(e.success&&e.vehicles){if(e.vehicles.length===0){s.innerHTML="<p>No vehicles registered yet.</p>";return}s.innerHTML=e.vehicles.map(t=>`
                    <div class="vehicle-card">
                        <h4>${t.make} ${t.model}</h4>
                        <p>Registration: ${t.registration_number}</p>
                        <p>Capacity: ${t.capacity} seats</p>
                        <p>Status: ${t.vehicle_status}</p>
                        ${t.driver_name?`<p>Driver: ${t.driver_name}</p>`:"<p>No driver assigned</p>"}
                    </div>
                `).join("")}}catch(e){console.error("Error loading owner vehicles:",e);const s=document.getElementById("ownerVehiclesList");s&&(s.innerHTML="<p>Error loading vehicles.</p>")}}async loadOwnerDrivers(){try{const e=await U(),s=document.getElementById("ownerDriversList");if(!s)return;if(e.success&&e.drivers){if(e.drivers.length===0){s.innerHTML="<p>No drivers assigned yet.</p>";return}s.innerHTML=e.drivers.map(t=>`
                    <div class="driver-card">
                        <h4>${t.name}</h4>
                        <p>Email: ${t.email}</p>
                        <p>Phone: ${t.phone||"N/A"}</p>
                        <p>License: ${t.license_number||"N/A"}</p>
                        <p>Vehicles: ${t.vehicle_count||0}</p>
                    </div>
                `).join("")}}catch(e){console.error("Error loading owner drivers:",e);const s=document.getElementById("ownerDriversList");s&&(s.innerHTML="<p>Error loading drivers.</p>")}}async loadOwnerRevenue(){try{const e=await N(),s=document.getElementById("revenueSummary"),t=document.getElementById("revenueTransactions");if(s&&e.summary&&(s.innerHTML=`
                    <div class="revenue-summary-card">
                        <h3>Total Earnings: R${parseFloat(e.summary.total_earnings||0).toFixed(2)}</h3>
                        <p>Total Commission: R${parseFloat(e.summary.total_commission||0).toFixed(2)}</p>
                        <p>Total Transactions: ${e.summary.total_transactions||0}</p>
                    </div>
                `),t&&e.transactions){if(e.transactions.length===0){t.innerHTML="<p>No revenue transactions yet.</p>";return}t.innerHTML=e.transactions.map(i=>`
                    <div class="transaction-card">
                        <p>Amount: R${parseFloat(i.owner_amount||0).toFixed(2)}</p>
                        <p>Date: ${new Date(i.created_at).toLocaleDateString()}</p>
                        <p>Status: ${i.status}</p>
                    </div>
                `).join("")}}catch(e){console.error("Error loading owner revenue:",e)}}async loadAdminDashboard(){try{const e=await I(),s=document.getElementById("adminStats");if(!s)return;if(e.success&&e.statistics){const t=e.statistics;s.innerHTML=`
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Bookings</h3>
                            <p>${t.total_bookings||0}</p>
                        </div>
                        <div class="stat-card">
                            <h3>Pending</h3>
                            <p>${t.pending||0}</p>
                        </div>
                        <div class="stat-card">
                            <h3>Completed</h3>
                            <p>${t.completed||0}</p>
                        </div>
                        <div class="stat-card">
                            <h3>Total Revenue</h3>
                            <p>R${parseFloat(t.total_revenue||0).toFixed(2)}</p>
                        </div>
                    </div>
                `}}catch(e){console.error("Error loading admin dashboard:",e)}}async loadUserManagement(){try{const e=document.getElementById("userManagementList");e&&(e.innerHTML="<p>User management feature coming soon.</p>")}catch(e){console.error("Error loading user management:",e)}}async loadUserData(){try{const e=await d.get(`${m}/auth/profile`);if(e.data.success)this.currentUser=e.data.user,localStorage.setItem("userProfile",JSON.stringify(this.currentUser));else{const s=localStorage.getItem("userProfile");if(s)this.currentUser=JSON.parse(s);else{window.location.href="/index.html";return}}}catch(e){if(console.error("Error loading user data:",e),e.response&&(e.response.status===401||e.response.status===403)){console.log("Session expired, redirecting to home page"),localStorage.removeItem("userProfile"),window.location.href="/index.html";return}const s=localStorage.getItem("userProfile");if(s)this.currentUser=JSON.parse(s),console.log("this.currentUser:",this.currentUser);else{window.location.href="/index.html";return}}this.currentUser&&(this.updateProfileDisplay(),this.populateForms())}saveUserData(){localStorage.setItem("userProfile",JSON.stringify(this.currentUser))}updateProfileDisplay(){const e=document.getElementById("displayName"),s=document.getElementById("userHandle"),t=document.getElementById("userEmail"),i=document.getElementById("profilePicture");e&&(e.textContent=`${this.currentUser.firstName} ${this.currentUser.lastName}`),s&&(s.textContent=`@${this.currentUser.username}`),t&&(t.textContent=this.currentUser.email),i&&this.currentUser.profilePicture&&(i.src=this.currentUser.profilePicture)}populateForms(){const e=document.getElementById("personalInfoForm");e&&(e.firstName.value=this.currentUser.firstName||"",e.lastName.value=this.currentUser.lastName||"",e.username.value=this.currentUser.username||"",e.phone.value=this.currentUser.phone||"",e.location.value=this.currentUser.location||"");const s=document.getElementById("currentEmail");s&&(s.value=this.currentUser.email||"")}setupEventListeners(){const e=document.getElementById("profilePictureInput");e&&e.addEventListener("change",r=>this.handleProfilePictureUpload(r));const s=document.getElementById("personalInfoForm");s&&s.addEventListener("submit",r=>this.handlePersonalInfoSubmit(r));const t=document.getElementById("emailChangeForm");t&&t.addEventListener("submit",r=>this.handleEmailChangeSubmit(r));const i=document.getElementById("passwordChangeForm");i&&i.addEventListener("submit",r=>this.handlePasswordChangeSubmit(r));const n=document.getElementById("businessInfoForm");n&&n.addEventListener("submit",r=>this.handleBusinessInfoSubmit(r))}async handleBusinessInfoSubmit(e){var i,n;e.preventDefault();const s=new FormData(e.target),t=Object.fromEntries(s);try{const r=await A({business_name:t.businessName,business_type:t.businessType,business_registration_number:t.businessRegistrationNumber,tax_number:t.taxNumber});r.success?(this.showMessage("Business information updated successfully!","success"),this.addActivityLog("profile","Business information updated"),await this.loadOwnerProfile()):this.showMessage(r.message||"Failed to update business information","error")}catch(r){console.error("Error updating business info:",r);const o=((n=(i=r.response)==null?void 0:i.data)==null?void 0:n.message)||"Failed to update business information. Please try again.";this.showMessage(o,"error")}}async handleProfilePictureUpload(e){const s=e.target.files[0];if(s){if(!this.validateImageFile(s)){this.showMessage("Please select a valid image file (JPG, PNG, GIF) under 5MB.","error");return}try{const t=await this.processImage(s);this.currentUser.profilePicture=t,this.updateProfileDisplay(),this.saveUserData(),this.addActivityLog("profile","Profile picture updated"),this.showMessage("Profile picture updated successfully!","success")}catch{this.showMessage("Failed to process image. Please try again.","error")}}}validateImageFile(e){return!(!["image/jpeg","image/jpg","image/png","image/gif"].includes(e.type)||e.size>5242880)}processImage(e){return new Promise(s=>{const t=document.createElement("canvas"),i=t.getContext("2d"),n=new Image;n.onload=()=>{let{width:o,height:l}=n;o>l?o>300&&(l=l*300/o,o=300):l>300&&(o=o*300/l,l=300),t.width=o,t.height=l,i.drawImage(n,0,0,o,l);const u=t.toDataURL("image/jpeg",.8);s(u)},n.src=URL.createObjectURL(e)})}async handlePersonalInfoSubmit(e){var o,l,u,g,h,c,v,y,w,b;e.preventDefault();const s=new FormData(e.target),t=Object.fromEntries(s),i={},n=((o=t.firstName)==null?void 0:o.trim())||"",r=((l=t.lastName)==null?void 0:l.trim())||"";(n||r)&&(i.name=`${n} ${r}`.trim()),(u=t.username)!=null&&u.trim()&&(i.username=t.username.trim()),(g=t.phone)!=null&&g.trim()&&(i.phone=t.phone.trim()),(h=t.location)!=null&&h.trim()&&(i.location=t.location.trim()),this.currentUser.profilePicture&&(i.profile_picture=this.currentUser.profilePicture);try{const p=await d.put(`${m}/auth/profile`,i);p.data.success?(this.currentUser={...this.currentUser,firstName:n||this.currentUser.firstName||"",lastName:r||this.currentUser.lastName||"",username:((c=t.username)==null?void 0:c.trim())||this.currentUser.username||"",phone:((v=t.phone)==null?void 0:v.trim())||this.currentUser.phone||"",location:((y=t.location)==null?void 0:y.trim())||this.currentUser.location||""},this.saveUserData(),this.updateProfileDisplay(),this.addActivityLog("profile","Personal information updated"),this.showMessage("Personal information updated successfully!","success")):this.showMessage(p.data.message||"Failed to update profile","error")}catch(p){if(console.error("Error updating profile:",p),p.response&&(p.response.status===401||p.response.status===403)){this.showMessage("Session expired. Please log in again.","error"),setTimeout(()=>{this.handleLogout()},2e3);return}const E=((b=(w=p.response)==null?void 0:w.data)==null?void 0:b.message)||"Failed to update profile. Please try again.";this.showMessage(E,"error")}}async handleEmailChangeSubmit(e){e.preventDefault();const s=new FormData(e.target),t=Object.fromEntries(s);if(t.newEmail===this.currentUser.email){this.showMessage("New email must be different from current email.","error");return}this.showConfirmationModal(`Are you sure you want to change your email from ${this.currentUser.email} to ${t.newEmail}? A confirmation email will be sent to the new address.`,()=>this.confirmEmailChange(t))}async confirmEmailChange(e){var s,t;try{const i=await d.put(`${m}/auth/change-email`,{newEmail:e.newEmail,currentPassword:e.emailPassword});i.data.success?(i.data.emailSent?this.showMessage("Confirmation email sent to "+e.newEmail+". Please check your email to verify the change.","info"):(this.currentUser.email=e.newEmail,this.saveUserData(),this.updateProfileDisplay(),this.addActivityLog("security","Email address changed"),this.showMessage("Email address updated successfully!","success")),event.target.reset()):this.showMessage(i.data.message||"Failed to change email","error")}catch(i){if(console.error("Error changing email:",i),i.response&&(i.response.status===401||i.response.status===403)){this.showMessage("Session expired. Please log in again.","error"),setTimeout(()=>{this.handleLogout()},2e3);return}const n=((t=(s=i.response)==null?void 0:s.data)==null?void 0:t.message)||"Failed to change email. Please try again.";this.showMessage(n,"error")}}async handlePasswordChangeSubmit(e){e.preventDefault();const s=new FormData(e.target),t=Object.fromEntries(s);if(t.newPassword!==t.confirmPassword){this.showMessage("New passwords do not match.","error");return}if(this.checkPasswordStrength(t.newPassword)==="weak"){this.showMessage("Password is too weak. Please choose a stronger password.","error");return}this.showConfirmationModal("Are you sure you want to change your password? You will be logged out of all devices.",()=>this.confirmPasswordChange(t))}async confirmPasswordChange(e){var s,t;try{const i=await d.put(`${m}/auth/change-password`,{currentPassword:e.currentPassword,newPassword:e.newPassword});i.data.success?(this.showMessage("Password changed successfully! You will be logged out for security.","success"),this.addActivityLog("security","Password changed"),event.target.reset(),setTimeout(()=>{this.handleLogout()},2e3)):this.showMessage(i.data.message||"Failed to change password","error")}catch(i){if(console.error("Error changing password:",i),i.response&&(i.response.status===401||i.response.status===403)){this.showMessage("Session expired. Please log in again.","error"),setTimeout(()=>{this.handleLogout()},2e3);return}const n=((t=(s=i.response)==null?void 0:s.data)==null?void 0:t.message)||"Failed to change password. Please try again.";this.showMessage(n,"error")}}checkPasswordStrength(e){const s=/[a-z]/.test(e),t=/[A-Z]/.test(e),i=/\d/.test(e),n=/[!@#$%^&*(),.?":{}|<>]/.test(e),r=e.length>=8,o=[s,t,i,n,r].filter(Boolean).length;return o<3?"weak":o<4?"fair":o<5?"good":"strong"}setupPasswordStrength(){const e=document.getElementById("newPassword");e&&e.addEventListener("input",s=>{const t=this.checkPasswordStrength(s.target.value),i=document.getElementById("strengthFill"),n=document.getElementById("strengthText");i&&n&&(i.className=`strength-fill ${t}`,n.textContent=t.charAt(0).toUpperCase()+t.slice(1))})}setupTabNavigation(){const e=document.querySelectorAll(".tab-btn"),s=document.querySelectorAll(".tab-panel");e.forEach(t=>{t.addEventListener("click",()=>{const i=t.getAttribute("data-tab");e.forEach(n=>n.classList.remove("active")),s.forEach(n=>n.classList.remove("active")),t.classList.add("active"),document.getElementById(i).classList.add("active")})})}setupActivityFilters(){const e=document.querySelectorAll(".filter-btn");e.forEach(s=>{s.addEventListener("click",()=>{const t=s.getAttribute("data-filter");e.forEach(i=>i.classList.remove("active")),s.classList.add("active"),this.filterActivityLog(t)})})}filterActivityLog(e){if(!document.getElementById("activityList"))return;const t=e==="all"?this.activityLog:this.activityLog.filter(i=>i.type===e);this.renderActivityLog(t)}async loadActivityLog(){try{const e=await d.get(`${m}/auth/activities`);e.data.success?this.activityLog=e.data.activities.map(s=>({type:s.activity_type,title:s.activity_title,time:new Date(s.created_at),device:s.device_info||"Unknown",ip:s.ip_address||"Unknown",description:s.activity_description})):this.activityLog=[]}catch(e){console.error("Error loading activity log:",e),this.activityLog=[]}this.setupActivityFilters(),this.renderActivityLog(this.activityLog)}async addActivityLog(e,s){const t={type:e,title:s,time:new Date,device:this.getDeviceInfo(),ip:"Unknown"};this.activityLog.unshift(t),this.renderActivityLog(this.activityLog);try{await d.post(`${m}/auth/activities`,{activity_type:e,activity_title:s,activity_description:`${s} from ${this.getDeviceInfo()}`,ip_address:null,user_agent:navigator.userAgent,device_info:this.getDeviceInfo(),location_info:null})}catch(i){console.error("Error logging activity to backend:",i)}}getDeviceInfo(){const e=navigator.userAgent;return/Mobile|Android|iPhone|iPad/.test(e)?/iPhone/.test(e)?"iPhone":/Android/.test(e)?"Android":"Mobile Device":/Windows/.test(e)?"Windows":/Mac/.test(e)?"Mac":/Linux/.test(e)?"Linux":"Desktop"}renderActivityLog(e){const s=document.getElementById("activityList");s&&(s.innerHTML=e.map(t=>this.createActivityItem(t)).join(""))}createActivityItem(e){const s=this.getActivityIcon(e.type),t=this.getTimeAgo(e.time);return`
            <div class="activity-item">
                <div class="activity-icon ${e.type}">
                    <i class="fas ${s}"></i>
                </div>
                <div class="activity-details">
                    <div class="activity-title">${e.title}</div>
                    <div class="activity-time">${t} • ${e.device} • ${e.ip}</div>
                </div>
            </div>
        `}getActivityIcon(e){return{login:"fa-sign-in-alt",profile:"fa-user-edit",security:"fa-shield-alt"}[e]||"fa-info-circle"}getTimeAgo(e){const t=Math.floor((new Date-e)/1e3);return t<60?"Just now":t<3600?`${Math.floor(t/60)} minutes ago`:t<86400?`${Math.floor(t/3600)} hours ago`:`${Math.floor(t/86400)} days ago`}setupModalEvents(){const e=document.getElementById("confirmationModal"),s=e.querySelector(".close"),t=document.getElementById("cancelBtn");document.getElementById("confirmBtn"),s.addEventListener("click",()=>this.hideModal()),t.addEventListener("click",()=>this.hideModal()),window.addEventListener("click",i=>{i.target===e&&this.hideModal()})}showConfirmationModal(e,s){const t=document.getElementById("confirmationModal"),i=document.getElementById("modalMessage"),n=document.getElementById("confirmBtn");i.textContent=e,t.style.display="block";const r=n.cloneNode(!0);n.parentNode.replaceChild(r,n),r.addEventListener("click",()=>{this.hideModal(),s()})}hideModal(){const e=document.getElementById("confirmationModal");e.style.display="none"}showMessage(e,s="info"){const t=document.getElementById("messageContainer"),i=document.createElement("div");i.className=`message ${s}`,i.textContent=e,t.appendChild(i),setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},5e3)}setupMobileMenu(){console.log("Mobile menu setup completed")}setupBookingsTab(){const e=document.querySelectorAll(".booking-filters .filter-btn");e.forEach(s=>{s.addEventListener("click",()=>{e.forEach(i=>i.classList.remove("active")),s.classList.add("active");const t=s.getAttribute("data-filter");this.showBookingCategory(t)})}),this.loadBookings()}async loadBookings(){var e;try{const s=(e=this.currentUser)==null?void 0:e.user_type;let t;if(s==="driver"?t=await M():s==="owner"?t=await D():t=await T(),t.success&&t.bookings){const i=t.bookings,n=new Date,r={upcoming:i.filter(o=>o.booking_status==="paid"&&new Date(o.scheduled_pickup)>n),unpaid:i.filter(o=>o.booking_status==="pending"||o.booking_status==="confirmed"),history:i.filter(o=>o.booking_status==="paid"&&new Date(o.scheduled_pickup)<=n||o.booking_status==="completed")};this.displayUpcomingBookings(r.upcoming),this.displayUnpaidBookings(r.unpaid),this.displayHistoryBookings(r.history)}}catch(s){console.error("Error loading bookings:",s);const t=this.getBookingsFromStorage();this.displayUpcomingBookings(t.upcoming),this.displayUnpaidBookings(t.unpaid),this.displayHistoryBookings(t.history)}}getBookingsFromStorage(){const e=JSON.parse(localStorage.getItem("userBookings")||"[]"),s=new Date;return{upcoming:e.filter(t=>t.status==="paid"&&new Date(t.tripDate)>s),unpaid:e.filter(t=>t.status==="unpaid"||t.status==="confirmed"),history:e.filter(t=>t.status==="paid"&&new Date(t.tripDate)<=s||t.status==="completed")}}showBookingCategory(e){document.querySelectorAll(".booking-category").forEach(t=>{t.classList.remove("active")});const s=document.getElementById(`${e}-bookings`);s&&s.classList.add("active")}displayUpcomingBookings(e){const s=document.getElementById("upcoming-list");if(s){if(e.length===0){s.innerHTML=this.getEmptyBookingsHTML("upcoming");return}s.innerHTML=e.map(t=>this.getBookingCardHTML(t,"upcoming")).join(""),this.attachBookingEventListeners()}}displayUnpaidBookings(e){const s=document.getElementById("unpaid-list");if(s){if(e.length===0){s.innerHTML=this.getEmptyBookingsHTML("unpaid");return}s.innerHTML=e.map(t=>this.getBookingCardHTML(t,"unpaid")).join(""),this.attachBookingEventListeners()}}displayHistoryBookings(e){const s=document.getElementById("history-list");if(s){if(e.length===0){s.innerHTML=this.getEmptyBookingsHTML("history");return}s.innerHTML=e.map(t=>this.getBookingCardHTML(t,"history")).join(""),this.attachBookingEventListeners()}}getBookingCardHTML(e,s){const t=e.booking_status||e.status,i=e.booking_reference||e.reference,n=e.scheduled_pickup||e.tripDate,r=e.total_amount_paid||e.total_amount_needed||e.totalAmount,o=e.passenger_count||e.passengers||0,l=e.route_name||e.routeName||"Taxi Booking",u=t==="paid"?"paid":t==="unpaid"||t==="pending"||t==="confirmed"?"unpaid":"completed",g=t==="paid"?"PAID":t==="unpaid"||t==="pending"||t==="confirmed"?"UNPAID":t==="completed"?"COMPLETED":(t==null?void 0:t.toUpperCase())||"PENDING";return`
            <div class="booking-card ${u}" data-booking-id="${e.id}">
                <div class="booking-card-header">
                    <div class="booking-card-title">
                        <h4><i class="fas fa-taxi"></i> ${l}</h4>
                        <div class="booking-reference">Ref: ${i}</div>
                    </div>
                    <div class="booking-status-badge ${u}">${g}</div>
                </div>
                <div class="booking-card-body">
                    <div class="booking-detail-item">
                        <div class="booking-detail-label">Trip Date</div>
                        <div class="booking-detail-value">
                            <i class="fas fa-calendar"></i>
                            ${new Date(n).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="booking-detail-item">
                        <div class="booking-detail-label">Passengers</div>
                        <div class="booking-detail-value">
                            <i class="fas fa-users"></i>
                            ${o}
                        </div>
                    </div>
                    <div class="booking-detail-item">
                        <div class="booking-detail-label">Total Amount</div>
                        <div class="booking-detail-value">
                            <i class="fas fa-money-bill-wave"></i>
                            R${parseFloat(r||0).toFixed(2)}
                        </div>
                    </div>
                    <div class="booking-detail-item">
                        <div class="booking-detail-label">Booking Date</div>
                        <div class="booking-detail-value">
                            <i class="fas fa-clock"></i>
                            ${new Date(e.created_at||e.bookingDate).toLocaleDateString()}
                        </div>
                    </div>
                </div>
                <div class="booking-card-footer">
                    ${this.getBookingActionsHTML(e,s)}
                </div>
            </div>
        `}getBookingActionsHTML(e,s){let t="";return s==="unpaid"&&(t+=`
                <button class="booking-btn booking-btn-primary" onclick="profileManager.payForBooking('${e.id}')">
                    <i class="fas fa-credit-card"></i> Pay Now
                </button>
            `),t+=`
            <button class="booking-btn booking-btn-secondary" onclick="profileManager.viewBookingDetails('${e.id}')">
                <i class="fas fa-eye"></i> View Details
            </button>
        `,s==="unpaid"&&(t+=`
                <button class="booking-btn booking-btn-danger" onclick="profileManager.cancelBooking('${e.id}')">
                    <i class="fas fa-times"></i> Cancel
                </button>
            `),t}getEmptyBookingsHTML(e){const t={upcoming:{icon:"fa-calendar-check",title:"No Upcoming Trips",text:"You don't have any upcoming bookings. Book a taxi now!"},unpaid:{icon:"fa-exclamation-circle",title:"No Unpaid Bookings",text:"All your bookings are paid for!"},history:{icon:"fa-history",title:"No Trip History",text:"You haven't completed any trips yet."}}[e];return`
            <div class="empty-bookings">
                <i class="fas ${t.icon}"></i>
                <h4>${t.title}</h4>
                <p>${t.text}</p>
                ${e==="upcoming"||e==="history"?`
                    <a href="/pages/customer/booking-type-selection.html" class="btn">
                        <i class="fas fa-plus"></i> Book a Taxi
                    </a>
                `:""}
            </div>
        `}attachBookingEventListeners(){}payForBooking(e){const t=JSON.parse(localStorage.getItem("userBookings")||"[]").find(i=>i.id===e);if(!t){this.showMessage("Booking not found","error");return}localStorage.setItem("paymentData",JSON.stringify({bookingId:t.id,routeName:t.routeName,passengers:t.passengers,pricePerPerson:t.pricePerPerson,totalAmount:t.totalAmount,pickupPoints:t.pickupPoints||[],dropoffPoints:t.dropoffPoints||[]})),window.location.href="/pages/customer/booking-payment.html"}async viewBookingDetails(e){try{const s=await P(e);if(s.success&&s.booking){const t=s.booking;let i=`
                    <div style="text-align: left;">
                        <h3 style="margin-bottom: 1rem; color: #01386A;">Booking Details</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div><strong>Reference:</strong> ${t.booking_reference||t.reference}</div>
                            <div><strong>Route:</strong> ${t.route_name||t.routeName||"N/A"}</div>
                            <div><strong>Passengers:</strong> ${t.passenger_count||t.passengers||0}</div>
                            <div><strong>Parcels:</strong> ${t.parcel_count||0}</div>
                            <div><strong>Trip Date:</strong> ${new Date(t.scheduled_pickup||t.tripDate).toLocaleDateString()}</div>
                            <div><strong>Total Amount:</strong> R${parseFloat(t.total_amount_needed||t.totalAmount||0).toFixed(2)}</div>
                            <div><strong>Amount Paid:</strong> R${parseFloat(t.total_amount_paid||0).toFixed(2)}</div>
                            <div><strong>Status:</strong> ${(t.booking_status||t.status||"pending").toUpperCase()}</div>
                            ${t.driver_name?`<div><strong>Driver:</strong> ${t.driver_name}</div>`:""}
                            ${t.owner_name?`<div><strong>Owner:</strong> ${t.owner_name}</div>`:""}
                        </div>
                    </div>
                `;const n=document.getElementById("confirmationModal"),r=document.getElementById("modalMessage"),o=document.getElementById("confirmBtn");n&&r&&(r.innerHTML=i,o.style.display="none",n.style.display="block")}}catch(s){console.error("Error fetching booking details:",s),this.showMessage("Failed to load booking details","error")}}async cancelBooking(e){this.showConfirmationModal("Are you sure you want to cancel this booking? This action cannot be undone.",async()=>{var s,t;try{await $(e,"Cancelled by user"),await this.loadBookings(),this.showMessage("Booking cancelled successfully","success")}catch(i){console.error("Error cancelling booking:",i),this.showMessage(((t=(s=i.response)==null?void 0:s.data)==null?void 0:t.message)||"Failed to cancel booking","error")}})}}window.toggleMobileMenu=function(){const e=document.getElementById("mobileMenu").classList.toggle("show"),s=document.querySelector(".topnav");e?s.style.zIndex="3001":s.style.zIndex="1000"};window.topNavZIndexDecrease=function(){const a=document.querySelector(".topnav");a.style.zIndex="3"};let f;document.addEventListener("DOMContentLoaded",async()=>{try{f=new C,window.profileManager=f,await f.init()}catch(a){console.error("Failed to initialize profile manager:",a)}});
