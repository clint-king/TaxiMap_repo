var he=Object.defineProperty;var we=(t,o,e)=>o in t?he(t,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[o]=e;var $=(t,o,e)=>we(t,typeof o!="symbol"?o+"":o,e);import{B as Le}from"./AddressSelection-CWIIN_Gi.js";/* empty css               */import{r as ve}from"./logout-DBLdyFVo.js";import{a as Ee}from"./axios-D4YhIzwJ.js";const ae=Ee.create({withCredentials:!0,baseURL:Le});let y=1,a=null,M=!1,S=null,A=null,i=[],q=null,N=null,h=!0,g=[],l=[],m=null,f=null,B=null,z=null,G=null,C=null,H="#193148",w=!1,E=[],D=1,x=1,p=null,L=null,v=["#eba9b7","#BCF9F9","#F9E1BC","#C1F9BC","#A9C6EB"],U=null;class te{constructor(o){$(this,"name");$(this,"listOfCoords",[]);$(this,"message");$(this,"price",0);$(this,"routeMarkers",[]);$(this,"coords",[]);$(this,"isLoopRoutefinished",!1);this.name=o}hasRouteEnded(o){this.isLoopRoutefinished=o}AddMessage(o){this.message=o}AddPrice(o){this.price=o}AddListofMarkers(o){return o.length===0?!1:(this.routeMarkers.push(...o),!0)}AddCoords(o){return o.length===0?!1:(this.coords.push(...o),!0)}AddRouteCoords(o){return o.length===0?!1:(this.listOfCoords.push(...o),!0)}RoutePrint(){return`name: ${this.name}, message: ${this.message}, price: ${this.price}, listOfCoords: ${this.listOfCoords.length} points`}}function Ie(t){N=t,h=t==="Straight",document.querySelectorAll(".route-type-card").forEach(n=>{n.classList.remove("selected")}),event.currentTarget.classList.add("selected");const o=document.getElementById("step2Description"),e=document.getElementById("endLocation");h?(o.textContent="Choose your starting and destination taxi ranks",document.getElementById("endLocationGroup").style.display="block",e.required=!0):(o.textContent="Choose your starting taxi rank (loop route)",document.getElementById("endLocationGroup").style.display="none",e.required=!1,e.value=""),oe(),setTimeout(()=>{ue()},500)}function oe(){console.log("Step 1 UI Update:",{selectedRouteType:N,isComplete:N!==null})}document.addEventListener("DOMContentLoaded",()=>{Be()});async function Be(){try{if(!localStorage.getItem("userProfile")){window.location.href="/pages/authentication/login.html";return}await le(),Re(),V();const o=document.getElementById("endLocation");o&&(o.required=!0),oe(),console.log("Route suggestion app initialized successfully")}catch(t){console.error("Error initializing app:",t),c("Error initializing application. Please refresh the page.","error")}}async function le(){try{mapboxgl.accessToken="pk.eyJ1IjoiY2xpZXRpbiIsImEiOiJjbTR6eW1icmMxN3dyMmpzODBsZDQwNHN6In0.m5MSK2_0_SFpPPhB5BX86w",a=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v11",center:[28.0473,-26.2041],zoom:10}),a.addControl(new mapboxgl.NavigationControl),a.on("click",$e),a.on("load",()=>{console.log("Map loaded successfully")})}catch(t){console.error("Error initializing map:",t),c("Error loading map. Please check your internet connection.","error")}}function Re(){const t=document.getElementById("startLocation"),o=document.getElementById("endLocation");t&&re("startLocation","startSuggestions"),o&&re("endLocation","endSuggestions");const e=document.getElementById("routePrice");e&&e.addEventListener("input",()=>{P()}),Ce(),Me(),Se(),window.addEventListener("resize",()=>{a&&a.resize()})}function re(t,o){const e=document.getElementById(t),n=document.getElementById(o);let r;e.addEventListener("input",s=>{clearTimeout(r);const d=s.target.value.trim();if(Y(),d.length<2){n.classList.remove("show");return}r=setTimeout(()=>{xe(d,n)},300)}),document.addEventListener("click",s=>{!e.contains(s.target)&&!n.contains(s.target)&&n.classList.remove("show")})}async function xe(t,o){try{const r=(await ae.get("/admin/listTaxiRanks")).data.filter(s=>{var d;return s.name.toLowerCase().includes(t.toLowerCase())||((d=s.address)==null?void 0:d.toLowerCase().includes(t.toLowerCase()))});be(r,o)}catch(e){console.error("Error searching locations:",e),c("Error searching locations. Please try again.","error")}}function be(t,o){o.innerHTML="",t.length===0?o.innerHTML='<div class="suggestion-item">No locations found</div>':t.forEach(e=>{const n=document.createElement("div");n.className="suggestion-item",n.innerHTML=`
        <div><strong>${e.name}</strong></div>
        <div style="font-size: 0.9rem; color: #666;">${e.address||e.province}</div>
      `,n.addEventListener("click",()=>{const r=o.previousElementSibling.querySelector("input");r.value=e.name,o.classList.remove("show"),r.id==="startLocation"?m=e:r.id==="endLocation"&&(f=e),ce(e,r.id==="startLocation"?"start":"end"),Y()}),o.appendChild(n)}),o.classList.add("show")}function ce(t,o){o==="start"&&S?S.remove():o==="end"&&A&&A.remove();let e=[0,0];const n=t.location_coord||t.coord;if(n){console.log("Parsing coordinates:",n,"Type:",typeof n);try{if(Array.isArray(n))e=n;else if(typeof n=="object"&&n.lng&&n.lat)e=[n.lng,n.lat];else if(typeof n=="object"&&n.longitude&&n.latitude)e=[n.longitude,n.latitude];else if(typeof n=="string")try{const s=JSON.parse(n);Array.isArray(s)?e=s:s.lng&&s.lat?e=[s.lng,s.lat]:s.longitude&&s.latitude&&(e=[s.longitude,s.latitude])}catch{if(n.startsWith("POINT(")){const u=n.replace("POINT(","").replace(")","").split(" ");u.length>=2&&(e=[parseFloat(u[0]),parseFloat(u[1])])}}}catch(s){console.error("Error parsing coordinates:",s,n),e=[0,0]}}console.log("Final parsed coordinates:",e);const r=new mapboxgl.Marker({color:o==="start"?"#28a745":"#dc3545"}).setLngLat(e).addTo(a);o==="start"?S=r:A=r,a.flyTo({center:e,zoom:Math.max(a.getZoom(),12)})}function Ce(){document.querySelectorAll("form, .form-container").forEach(o=>{o.querySelectorAll("input[required], select[required], textarea[required]").forEach(n=>{n.addEventListener("blur",de),n.addEventListener("input",ne)})})}function Me(){const t=document.getElementById("del_close_button");t&&t.addEventListener("click",()=>{X(!1)});const o=document.getElementById("editbtnListMenu");o&&o.addEventListener("click",()=>{if(!B){c("Could not edit route","error");return}qe(B)});const e=document.getElementById("removebtnListMenu");e&&e.addEventListener("click",()=>{if(!z){c("Could not remove route","error");return}Oe(z)});const n=document.getElementById("edit_close_button");n&&n.addEventListener("click",()=>{J()});const r=document.getElementById("editNoBtn");r&&r.addEventListener("click",()=>{J()});const s=document.getElementById("editYesBtn");s&&s.addEventListener("click",()=>{Ge()})}function Se(){const t=document.getElementById("removeRoute_close_button"),o=document.getElementById("removeRouteNoBtn"),e=document.getElementById("removeRouteYesBtn");t&&t.addEventListener("click",()=>{Q()}),o&&o.addEventListener("click",()=>{Q()}),e&&e.addEventListener("click",()=>{U!==null&&(Je(U),console.log("Clicked route data-name:",U),pe(x),Q())})}function de(t){const o=t.target,e=o.value.trim();if(o.hasAttribute("required")&&!e)return K(o,"This field is required"),!1;if(o.type==="email"&&e&&!ke(e))return K(o,"Please enter a valid email address"),!1;if(o.type==="number"&&e){const n=parseFloat(e),r=parseFloat(o.getAttribute("min")),s=parseFloat(o.getAttribute("max"));if(r!==null&&n<r)return K(o,`Value must be at least ${r}`),!1;if(s!==null&&n>s)return K(o,`Value must be at most ${s}`),!1}return ne(t),!0}function K(t,o){ne({target:t}),t.style.borderColor="#dc3545";const e=document.createElement("div");e.className="field-error",e.style.color="#dc3545",e.style.fontSize="0.875rem",e.style.marginTop="0.25rem",e.textContent=o,t.parentNode.appendChild(e)}function ne(t){const o=t.target;o.style.borderColor="";const e=o.parentNode.querySelector(".field-error");e&&e.remove()}function ke(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}function ue(){Ae()&&y<4&&(y++,V(),y===3?Pe():y===4&&it())}function Te(){y>1&&(y--,V())}function Ae(){const o=document.getElementById(`step-${y}`).querySelectorAll("input[required], select[required], textarea[required]");let e=!0;if(o.forEach(n=>{de({target:n})||(e=!1)}),y===1)N||(c("Please select a route type.","error"),e=!1);else if(y===2){const n=document.getElementById("startLocation").value.trim(),r=document.getElementById("endLocation").value.trim();n||(c("Please select a starting taxi rank.","error"),e=!1),h&&!r&&(c("Please select a destination taxi rank.","error"),e=!1)}else if(y===3){i.length<2&&(c("Please draw a route with at least 2 points.","error"),e=!1);const n=document.getElementById("routePrice").value.trim();n?parseFloat(n)<=0&&(c("Please enter a valid price greater than 0.","error"),e=!1):(c("Please set a price for this route.","error"),e=!1)}return e}function V(){document.querySelectorAll(".step").forEach((t,o)=>{const e=o+1;t.classList.remove("active","completed"),e===y?t.classList.add("active"):e<y&&t.classList.add("completed")}),document.querySelectorAll(".step-content").forEach((t,o)=>{const e=o+1;t.classList.remove("active"),e===y&&t.classList.add("active")}),y===1?oe():y===2?Y():y===3&&(P(),setTimeout(()=>{a&&a.resize()},200))}function Y(){const t=document.getElementById("step2NextBtn");if(!t){console.log("Step 2 next button not found");return}const o=document.getElementById("startLocation").value.trim(),e=document.getElementById("endLocation").value.trim();let n=o;h&&(n=n&&e),console.log("Step 2 UI Update:",{startLocation:o,endLocation:e,isStraightRoute:h,isComplete:n,startLocationLength:o?o.length:0,endLocationLength:e?e.length:0}),t.disabled=!n}function Pe(){a||le(),setTimeout(()=>{a&&a.resize()},100),W(),ge(),L||(L=new te("1"),x=1,H=v[0]),De(),P()}function ge(){S&&S.remove(),A&&A.remove(),l=[];const t=document.getElementById("startLocation").value;if(t){const o=F(t);o&&(S=new mapboxgl.Marker({color:"#28a745"}).setLngLat(o).addTo(a),l[0]=o)}if(h){const o=document.getElementById("endLocation").value;if(o){const e=F(o);e&&(A=new mapboxgl.Marker({color:"#dc3545"}).setLngLat(e).addTo(a),l[1]=e)}}if(l.length>0){const o=new mapboxgl.LngLatBounds;l.forEach(e=>o.extend(e)),a.fitBounds(o,{padding:100})}}function F(t){let o=null;if(console.log("Getting coordinates for:",t),console.log("selectedStartLocation:",m),console.log("selectedEndLocation:",f),t===(m==null?void 0:m.name)?(o=m,console.log("Found in selectedStartLocation")):t===(f==null?void 0:f.name)&&(o=f,console.log("Found in selectedEndLocation")),!o)return console.log("Location not found for:",t),[28.0473,-26.2041];const e=o.location_coord||o.coord;if(e)try{if(Array.isArray(e))return e;if(typeof e=="object"&&e.lng&&e.lat)return[e.lng,e.lat];if(typeof e=="object"&&e.longitude&&e.latitude)return[e.longitude,e.latitude];if(typeof e=="string")try{const n=JSON.parse(e);if(Array.isArray(n))return n;if(n.lng&&n.lat)return[n.lng,n.lat];if(n.longitude&&n.latitude)return[n.longitude,n.latitude]}catch{const r=e.match(/POINT\(([^)]+)\)/);if(r){const s=r[1].split(" ").map(Number);return[s[0],s[1]]}}}catch(n){console.error("Error parsing coordinates:",n)}return console.log("Could not parse coordinates for:",t,e),[28.0473,-26.2041]}function P(){const t=document.getElementById("step3NextBtn"),o=document.getElementById("routePrice"),e=i.length>=2,n=o&&o.value.trim()&&parseFloat(o.value)>0,r=e&&n;console.log("Step 3 UI Update:",{routeCoordinatesLength:i.length,hasRoute:e,routePriceValue:o?o.value:"no price element",hasPrice:n,isComplete:r,buttonDisabled:!r}),t.disabled=!r,!e&&!n?t.innerHTML='Draw route and set price <i class="fas fa-arrow-right"></i>':e?n?t.innerHTML='Next: Review Route <i class="fas fa-arrow-right"></i>':t.innerHTML='Set route price <i class="fas fa-arrow-right"></i>':t.innerHTML='Draw route to continue <i class="fas fa-arrow-right"></i>'}async function $e(t){if(!M)return;const o=[t.lngLat.lng,t.lngLat.lat];l.push(o),console.log("Current coords array:",l),console.log("Current routeCoordinates array:",i),console.log("Current routeMarkers array length:",g.length);let e,n;if(l.length===2?(e=l[0],n=l[1],h===!1&&(i.length=0,i.push(e))):l.length===3&&h===!0?(e=l[0],n=l[2],i.length=0,i.push(e)):(l.length>3||l.length===3&&h===!1)&&(e=l[l.length-2],n=l[l.length-1]),e&&n)try{console.log("Generating route segment between:",e,"and",n);const r=await Z(e,n);if(console.log("Received segment:",r),console.log("Segment type:",typeof r),console.log("Is array:",Array.isArray(r)),!r||!Array.isArray(r))throw new Error("Invalid segment data received");l.length===3||l.length===2&&h===!1?(console.log("Adding segment (first connection):",r.slice(1)),i.push(...r.slice(1))):l.length>3&&(console.log("Adding segment (continuation):",r.slice(1)),i.push(...r.slice(1))),O({type:"LineString",coordinates:i}),ee(o);const s=document.getElementById("drawStatus");s&&(s.textContent=`Route points: ${l.length}. Click to add more waypoints.`),P()}catch(r){console.error("Error generating route segment:",r),c("Error generating route segment. Please try again.","error")}}function De(){M=!1;const t=document.getElementById("drawStatus");t.textContent='Click "Start Drawing" to begin drawing your route',a.getCanvas().style.cursor="";const o=document.getElementById("clearRouteBtn"),e=document.getElementById("finishRouteBtn");o.disabled=!0,e.disabled=!0}function me(){if(w){c('Route is already completed. Use "Clear Route" to start over.',"warning");return}M=!M;const t=document.getElementById("drawRouteBtn"),o=document.getElementById("clearRouteBtn"),e=document.getElementById("finishRouteBtn"),n=document.getElementById("drawStatus");M?(t.innerHTML='<i class="fas fa-stop"></i> Stop Drawing',t.classList.remove("btn-outline"),t.classList.add("btn-success"),o.disabled=!1,e.disabled=!1,n.textContent="Click on the map to add waypoints to your route.",a.getCanvas().style.cursor="crosshair"):(t.innerHTML='<i class="fas fa-pencil-alt"></i> Start Drawing',t.classList.remove("btn-success"),t.classList.add("btn-outline"),n.textContent='Drawing stopped. Click "Start Drawing" to continue adding waypoints.',a.getCanvas().style.cursor="",o.disabled=!0,e.disabled=!0),P()}async function Ne(){if(h===!0)if(console.log("Finishing straight route - connecting to destination"),l.length>=3){const t=l.length-1,o=A.getLngLat();`${l[t].join(",")}${[o.lng,o.lat].join(",")}`;try{const e=await Z(l[t],[o.lng,o.lat]);i.push(...e.slice(1)),O({type:"LineString",coordinates:i}),M=!1,w=!0;const n=document.getElementById("drawRouteBtn"),r=document.getElementById("drawStatus");n.innerHTML='<i class="fas fa-pencil-alt"></i> Start Drawing',n.classList.remove("btn-success"),n.classList.add("btn-outline"),r.textContent="Route completed! Connected to destination.",a.getCanvas().style.cursor="",ie(),P(),j(),c("Route completed successfully!","success")}catch(e){console.error("Error finishing route:",e),c("Error completing route. Please try again.","error")}}else c("Please draw at least 2 waypoints before finishing the route.","error");else if(console.log("Finishing loop route - connecting to starting point"),l.length>=2){const t=l.length-1,o=S.getLngLat();`${l[t].join(",")}${[o.lng,o.lat].join(",")}`;try{const e=await Z(l[t],[o.lng,o.lat]);i.push(...e.slice(1)),O({type:"LineString",coordinates:i}),M=!1,w=!0;const n=document.getElementById("drawRouteBtn"),r=document.getElementById("drawStatus");n.innerHTML='<i class="fas fa-pencil-alt"></i> Start Drawing',n.classList.remove("btn-success"),n.classList.add("btn-outline"),r.textContent="Loop route completed! Connected back to starting point.",a.getCanvas().style.cursor="",ie(),P(),j(),c("Loop route completed successfully!","success")}catch(e){console.error("Error finishing loop route:",e),c("Error completing loop route. Please try again.","error")}}else c("Please draw at least 1 waypoint before finishing the loop route.","error")}function W(){a.getSource("route")&&(a.removeLayer("route"),a.removeSource("route")),g.forEach(r=>{r&&r.remove()}),i=[],g=[],l=[],B=null,z=null,G=null,C=null,X(!1),J(),M=!1,w=!1;const t=document.getElementById("drawRouteBtn"),o=document.getElementById("clearRouteBtn"),e=document.getElementById("finishRouteBtn"),n=document.getElementById("drawStatus");t&&(t.innerHTML='<i class="fas fa-pencil-alt"></i> Start Drawing',t.classList.remove("btn-success"),t.classList.add("btn-outline")),o&&(o.disabled=!0),e&&(e.disabled=!0),n&&(n.textContent='Click "Start Drawing" to begin drawing your route'),a&&(a.getCanvas().style.cursor=""),ge(),P(),j()}function O(t){a.getSource("route")?a.getSource("route").setData(t):(a.addSource("route",{type:"geojson",data:t}),a.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#193148","line-width":4}}))}function ee(t){const o=document.createElement("div");o.style.width="12px",o.style.height="12px",o.style.borderRadius="50%",o.style.backgroundColor="#007bff",o.style.border="2px solid white",o.style.boxShadow="0 2px 4px rgba(0,0,0,0.3)";const e=new mapboxgl.Marker(o).setLngLat(t).addTo(a);g.push(e),e.coordIndex=l.length-1,e.routeStartingIndex=i.length-1,e.routeMarkerIndex=g.length-1,e.getElement().addEventListener("contextmenu",n=>{n.preventDefault(),n.stopPropagation(),z===null&&B===null&&(Fe(),z=e,B=e)})}async function Z(t,o){try{const e="pk.eyJ1IjoiY2xpZXRpbiIsImEiOiJjbTR6eW1icmMxN3dyMmpzODBsZDQwNHN6In0.m5MSK2_0_SFpPPhB5BX86w",r=`https://api.mapbox.com/directions/v5/mapbox/driving/${`${t.join(",")};${o.join(",")}`}?geometries=geojson&access_token=${e}`;console.log("Requesting route from:",t,"to:",o),console.log("URL:",r),console.log("Token available:",!!e);const s=await fetch(r);if(!s.ok){const b=await s.text();throw console.error("API Error Response:",b),new Error(`HTTP error! status: ${s.status}`)}const d=await s.json();if(console.log("Mapbox API response:",d),!d.routes||!d.routes[0]||!d.routes[0].geometry)throw console.error("Invalid API response structure:",d),new Error("Invalid API response structure");const u=d.routes[0].geometry;if(console.log("Route segment:",u),!u.coordinates)throw console.error("No coordinates in route segment:",u),new Error("No coordinates in route segment");return console.log("Returning coordinates:",u.coordinates),u.coordinates}catch(e){return console.error("Error in routeGeneration:",e),console.log("Using fallback straight line"),[t,o]}}function Fe(){const t=document.getElementById("markerContextMenu");t&&(t.style.visibility="visible")}function X(t=!1){const o=document.getElementById("markerContextMenu");o&&(o.style.visibility="hidden"),z=null,t||(B=null)}function Oe(t){const o=t.getLngLat(),e=t.routeStartingIndex,n=t.coordIndex,r=t.routeMarkerIndex;if(console.log("**MARKER** coordinates found:",o),console.log("**MARKER** routeStartingIndex:",e),console.log("**MARKER** coordIndex:",n),console.log("**MARKER** routeMarkerIndex:",r),a.getSource("route")){O({type:"LineString",coordinates:i.slice(0,e+1)});for(let d=r+1;d<g.length;d++){const u=g[d];u&&u.remove()}i=i.slice(0,e+1),l=l.slice(0,n+1),g.length=r+1}X(!1)}function qe(t){const o=t.getLngLat(),e=t.routeStartingIndex,n=t.coordIndex;console.log("**MARKER** coordinates found:",o),console.log("**MARKER** routeStartingIndex:",e),console.log("**MARKER** coordIndex:",n),ze();const r=g.findIndex(R=>o.lng===R.getLngLat().lng&&o.lat===R.getLngLat().lat);if(r===-1){console.log("index is -1");return}let s=r-1;s<0&&(s=null);let d=r+1;d>=g.length&&(d=null);const u=s!==null?g[s]:null,b=d!==null?g[d]:null;console.log("markerBehind:",u),console.log("markerFoward:",b);let I;if(u===null?I=0:I=u.routeStartingIndex,console.log("startingIndex:",I),console.log("routeCoordinates:",i),I>=0){console.log("first index:",0,"startingIndex of markerBehind:",I+1);const R=i.slice(0,I+1);He(R,H)}else console.log("startingIndex:",I);let k;if(b===null?k=i.length:k=b.routeStartingIndex,k>=0){console.log("indexOfCurrentMarker:",e,"endingIndex:",k);const T=i.slice(k,i.length);je(T,H)}else console.log("endingIndex:",k);if(G=u,console.log("globalMarkerBehind:",G),X(!0),c("Click in a new area to edit the route","info"),!t._draggable){const R=t.getLngLat();t.getElement().style.display="none";const T=new mapboxgl.Marker({color:"orange",draggable:!0}).setLngLat(R).addTo(a);T.coordIndex=t.coordIndex,T.routeStartingIndex=t.routeStartingIndex,T.on("dragend",()=>{const _=T.getLngLat();console.log("Dragged and dropped:",_),C=T,Ke()})}}function ze(){a.getLayer("route")&&a.removeLayer("route"),a.getSource("route")&&a.removeSource("route")}function He(t,o){console.log("behind coords:",t),a.addSource("routeBehind",{type:"geojson",data:{type:"LineString",coordinates:t}}),a.addLayer({id:"routeBehind",type:"line",source:"routeBehind",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":o,"line-width":4}})}function je(t,o){console.log("forward coords:",t),a.addSource("routeFoward",{type:"geojson",data:{type:"LineString",coordinates:t}}),a.addLayer({id:"routeFoward",type:"line",source:"routeFoward",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":o,"line-width":4}})}function _e(){["routeBehind","routeFoward"].forEach(o=>{a.getLayer(o)&&a.removeLayer(o),a.getSource(o)&&a.removeSource(o)}),console.log("Both routeBehind and routeFoward have been removed.")}function Ue(t,o,e,n,r){const s=o-t+1;return i.splice(t,s,...r),l[e]=n,console.log("Edit routeCoords 2:",...r),t+r.length-1}async function Ge(){let t;G?t=G:t=S,console.log("markerBehind in [recreateRouteAfterEdit]:",t);const o=await Z([t.getLngLat().lng,t.getLngLat().lat],[C.getLngLat().lng,C.getLngLat().lat]);console.log("Edit routeCoords 1:",o),console.log("Routes coord before:",i);let e;t.routeStartingIndex?e=t.routeStartingIndex:e=0,console.log("StartingIndex:",e);const n=Ue(e,B.routeStartingIndex,B.coordIndex,[C.getLngLat().lng,C.getLngLat().lat],o);console.log("Routes coord after:",i),B.setLngLat([C.getLngLat().lng,C.getLngLat().lat]),B.routeStartingIndex=n,B.getElement().style.display="",_e(),O({type:"LineString",coordinates:i}),console.log("markerChosenForEditing index in Coords:",B.coordIndex),console.log("Coords:",l),J(),B=null,C&&(C.remove(),C=null)}function Ke(){const t=document.getElementById("editMarkerMenu");t&&(t.style.visibility="visible")}function J(){const t=document.getElementById("editMarkerMenu");t&&(t.style.visibility="hidden")}function Ze(t){U=t;const o=document.getElementById("removeRouteMessage");o&&(o.textContent=`Do you want to remove the route Route ${t}?`);const e=document.getElementById("removeRouteMenu");e&&(e.style.visibility="visible")}function Q(){const t=document.getElementById("removeRouteMenu");t&&(t.style.visibility="hidden"),U=null}function Je(t){let o=-1;if(E.forEach((e,n)=>{e.name===`${t}`&&(o=n)}),o!==-1){E.splice(o,1);let e=document.querySelector(`.route_div[data-name="${t}"]`);e&&e.remove(),j(),c(`Route ${t} deleted successfully.`,"success")}else console.log("ERROR: Could not find the route"),c("Error: Could not find the route to delete.","error")}function Ve(t){q=t,document.getElementById("locationModal").classList.add("show"),Ye()}function Ye(){const t=new mapboxgl.Map({container:"locationMap",style:"mapbox://styles/mapbox/streets-v11",center:[28.0473,-26.2041],zoom:10});window.locationMarker=null,We(),t.on("click",async o=>{window.locationMarker&&window.locationMarker.remove(),window.locationMarker=new mapboxgl.Marker().setLngLat([o.lngLat.lng,o.lngLat.lat]).addTo(t);try{const e=await tt(o.lngLat.lng,o.lngLat.lat);document.getElementById("newLocationAddress").value=e}catch(e){console.error("Error getting address:",e),document.getElementById("newLocationAddress").value=`${o.lngLat.lat.toFixed(6)}, ${o.lngLat.lng.toFixed(6)}`}}),window.locationMap=t,console.log("Location map initialized:",window.locationMap)}function We(){const t=document.getElementById("newLocationAddress"),o=document.getElementById("addressSuggestions");let e;t.addEventListener("input",n=>{clearTimeout(e);const r=n.target.value.trim();if(r.length<3){o.style.display="none";return}e=setTimeout(()=>{Xe(r,o)},300)}),document.addEventListener("click",n=>{!t.contains(n.target)&&!o.contains(n.target)&&(o.style.display="none")})}async function Xe(t,o){try{const n=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(t)}.json?access_token=${mapboxgl.accessToken}&country=ZA&limit=5`)).json();n.features&&n.features.length>0?Qe(n.features,o):o.style.display="none"}catch(e){console.error("Error searching addresses:",e),o.style.display="none"}}function Qe(t,o){o.innerHTML="",t.forEach(e=>{const n=document.createElement("div");n.className="address-suggestion-item";const r=document.createElement("div");r.className="suggestion-text",r.textContent=e.place_name;const s=document.createElement("div");s.className="suggestion-details",s.textContent=`${e.properties.category||"Location"}`,n.appendChild(r),n.appendChild(s),n.addEventListener("click",()=>{et(e)}),o.appendChild(n)}),o.style.display="block"}function et(t){console.log("Address suggestion selected:",t);const o=document.getElementById("newLocationAddress"),e=document.getElementById("addressSuggestions");if(o.value=t.place_name,e.style.display="none",window.locationMap){const[n,r]=t.center;console.log("Updating marker to coordinates:",n,r),window.locationMarker&&(console.log("Removing existing marker"),window.locationMarker.remove()),window.locationMarker=new mapboxgl.Marker().setLngLat([n,r]).addTo(window.locationMap),console.log("New marker added:",window.locationMarker),window.locationMap.flyTo({center:[n,r],zoom:15}),console.log("Map centered on:",n,r)}else console.error("Location map not found. Available:",{locationMap:window.locationMap,locationMarker:window.locationMarker})}async function tt(t,o){try{const n=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${t},${o}.json?access_token=${mapboxgl.accessToken}&country=ZA`)).json();return n.features&&n.features.length>0?n.features[0].place_name:`${o.toFixed(6)}, ${t.toFixed(6)}`}catch(e){return console.error("Error in reverse geocoding:",e),`${o.toFixed(6)}, ${t.toFixed(6)}`}}function fe(){document.getElementById("locationModal").classList.remove("show"),q=null,document.getElementById("newLocationName").value="",document.getElementById("newLocationProvince").value="",document.getElementById("newLocationAddress").value="";const t=document.getElementById("addressSuggestions");t&&(t.style.display="none"),window.locationMarker&&(window.locationMarker.remove(),window.locationMarker=null)}function ot(){if(D>=5){c("Maximum of 5 routes allowed per taxi rank pair.","error");return}i.length>0&&!w&&ye();const t=D+1;L=new te(`${t}`),H=v[t-1],x=t,D++,nt(`Route${t}`,H,t),w=!1,p=null,W(),me(),P(),j(),c(`Route ${t} created. You can now draw a new route.`,"success")}function nt(t,o,e){const n=document.querySelector(".addRoute");if(!n)return;const r=document.createElement("div");r.className="route_div",r.style.backgroundColor=o,r.setAttribute("data-name",e),r.innerHTML=`
    ${t}
    <button class="routeButton" style="background-color: ${o}" onclick="showRoute(${e})">
      <i class="fa fa-eye" style="font-size: 12px; color: black;" aria-hidden="true"></i>
    </button>
    <button class="routeButton routeDeleteBtn" style="background-color: ${o}" onclick="openRemoveRouteMenu(${e})" ${e===x?"disabled":""}>
      <i class="fa fa-times" style="font-size: 12px; color: black;" aria-hidden="true"></i>
    </button>
  `,n.appendChild(r)}function pe(t){if(x==t){if(p!==null){if(se(),l.push(...p.coords),w=p.isLoopRoutefinished,g.push(...p.routeMarkers),i.push(...p.listOfCoords),document.getElementById("routePrice")){const n=document.getElementById("routePrice").value;(!n||n.trim()==="")&&(document.getElementById("routePrice").value=p.message||"0")}console.log("Coords : ",l),console.log("routeMarkers : ",g),console.log("routeCoordinates : ",i),g.forEach(n=>{n&&ee([n.getLngLat().lng,n.getLngLat().lat])}),O({type:"LineString",coordinates:p.listOfCoords}),p=null}else console.log("Current route is already displayed - no saved data to load");const e=document.getElementById("drawRouteBtn");e&&(w?(e.disabled=!0,e.innerHTML='<i class="fas fa-pencil-alt"></i> Start Drawing',e.classList.remove("btn-success"),e.classList.add("btn-outline"),M=!1,a.getCanvas().style.cursor=""):(e.disabled=!1,e.innerHTML='<i class="fas fa-pencil-alt"></i> Start Drawing',e.classList.remove("btn-success"),e.classList.add("btn-outline"),M=!1,a.getCanvas().style.cursor=""));return}if(p===null&&ye()===!1){console.log("ERROR: Could not save unfinished route");return}E.forEach(e=>{e.name===`${t}`&&(se(),console.log("New route : ",JSON.stringify(e.listOfCoords)),l.push(...e.coords),w=e.isLoopRoutefinished,g.push(...e.routeMarkers),i.push(...e.listOfCoords),console.log("Coords : ",l),console.log("routeMarkers : ",g),console.log("routeCoordinates : ",i),g.forEach(n=>{n&&ee([n.getLngLat().lng,n.getLngLat().lat])}),O({type:"LineString",coordinates:e.listOfCoords}))});const o=document.getElementById("drawRouteBtn");o&&(o.disabled=!0,o.innerHTML='<i class="fas fa-pencil-alt"></i> Start Drawing',o.classList.remove("btn-success"),o.classList.add("btn-outline"))}function rt(t){if(t===x){c("Cannot delete the current active route.","error");return}const o=E.findIndex(n=>n.name===`${t}`);o!==-1&&E.splice(o,1);const e=document.querySelector(`.route_div[data-name="${t}"]`);e&&e.remove(),D--,j(),c(`Route ${t} deleted successfully.`,"success")}function ye(){var r;if(p=new te("Unfinished"),!i||i.length===0)return console.log("routeCoordinates has no coordinates"),c("There is no route drawn","error"),!1;if(p.AddRouteCoords(i)===!1)return console.log("*********ERROR: Could not add route  "),!1;if(p.AddCoords(l)===!1)return console.log("*********ERROR: Could not add all Marker (a.k.a coords)  "),!1;if(p.AddListofMarkers(g)===!1)return console.log("*********ERROR: Could not add innerMarkers"),!1;p.hasRouteEnded(w);const n=((r=document.getElementById("routePrice"))==null?void 0:r.value)||"0";return n.trim()===""?p.AddMessage(""):p.AddMessage(n),!0}function se(){a.getSource("route")&&(a.removeLayer("route"),a.removeSource("route")),i=[],l=[],g.forEach(t=>{t&&t.remove()}),g=[]}function ie(){var o;if(!L||i.length===0)return;L.AddRouteCoords([...i]),L.AddListofMarkers([...g]),L.AddCoords([...l]),L.hasRouteEnded(w),L.AddPrice(parseFloat((o=document.getElementById("routePrice"))==null?void 0:o.value)||0);const t=E.findIndex(e=>e.name===L.name);t!==-1?E[t]=L:E.push(L),console.log("Route saved:",L.RoutePrint())}function j(){const t=document.getElementById("addRouteBtn"),o=document.querySelectorAll(".routeDeleteBtn");t&&(t.disabled=D>=5||!w,console.log("Add Route Button State:",{routeCount:D,routeFinished:w,buttonDisabled:t.disabled,maxReached:D>=5})),o.forEach(e=>{const n=e.closest(".route_div"),r=parseInt(n.getAttribute("data-name"));e.disabled=r===x})}async function st(){try{const t=document.getElementById("newLocationName").value.trim(),o=document.getElementById("newLocationProvince").value,e=document.getElementById("newLocationAddress").value.trim();if(!t||!o){c("Please fill in all required fields.","error");return}if(!window.locationMarker){c("Please click on the map to set the location.","error");return}const n=window.locationMarker.getLngLat(),r={ID:1/0,name:t,province:o,address:e,location_coord:`POINT(${n.lng} ${n.lat})`,coord:[n.lng,n.lat],exist:!1},s=q==="start"?"startLocation":"endLocation";document.getElementById(s).value=t,q==="start"?m=r:q==="end"&&(f=r),ce(r,q),Y(),fe(),c("New location created successfully!","success")}catch(t){console.error("Error saving new location:",t),c("Error creating new location. Please try again.","error")}}function it(){const t=document.getElementById("reviewRouteName"),o=document.getElementById("reviewRouteType"),e=document.getElementById("reviewTravelMethod"),n=document.getElementById("reviewPrice"),r=document.getElementById("reviewDescription");if(t&&(t.textContent=`${document.getElementById("startLocation").value}${h?" to "+document.getElementById("endLocation").value:" (Loop)"}`),o&&(o.textContent=N||"-"),e&&(e.textContent="Taxi"),n){const u=document.getElementById("routePrice").value;n.textContent=u?`ZAR ${u}`:"Not specified"}if(r){const u=E.length+(i.length>0?1:0),b=E.reduce((I,k)=>{var R;return I+(((R=k.listOfCoords)==null?void 0:R.length)||0)},0)+i.length;r.textContent=`${u} ${N} route(s) with ${b} total waypoints`}const s=document.getElementById("reviewStartLocation"),d=document.getElementById("reviewEndLocation");s&&(s.textContent=document.getElementById("startLocation").value||"-"),d&&(h?d.textContent=document.getElementById("endLocation").value||"-":d.textContent="Same as start (Loop route)"),at()}function at(){const t=new mapboxgl.Map({container:"routePreviewMap",style:"mapbox://styles/mapbox/streets-v11",center:i.length>0?i[0]:[28.0473,-26.2041],zoom:10});t.on("load",()=>{if(E.forEach((o,e)=>{if(o.listOfCoords&&o.listOfCoords.length>1){const n=`preview-route-${e}`,r=`preview-route-${e}`;t.addSource(n,{type:"geojson",data:{type:"Feature",properties:{routeName:o.name,routeColor:v[e]||v[0]},geometry:{type:"LineString",coordinates:o.listOfCoords}}}),t.addLayer({id:r,type:"line",source:n,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":v[e]||v[0],"line-width":4}})}}),i.length>1){const o="preview-current-route",e="preview-current-route";t.addSource(o,{type:"geojson",data:{type:"Feature",properties:{routeName:`Route ${x}`,routeColor:v[x-1]||v[0]},geometry:{type:"LineString",coordinates:i}}}),t.addLayer({id:e,type:"line",source:o,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":v[x-1]||v[0],"line-width":4}})}lt(t),ct(t)})}function lt(t){if(m){const o=F(m.name);new mapboxgl.Marker({color:"#28a745"}).setLngLat(o).setPopup(new mapboxgl.Popup().setHTML(`<strong>Start:</strong> ${m.name}`)).addTo(t)}if(h&&f){const o=F(f.name);new mapboxgl.Marker({color:"#dc3545"}).setLngLat(o).setPopup(new mapboxgl.Popup().setHTML(`<strong>End:</strong> ${f.name}`)).addTo(t)}}function ct(t){const o=[];if(E.forEach(e=>{e.listOfCoords&&e.listOfCoords.length>0&&o.push(...e.listOfCoords)}),i.length>0&&o.push(...i),m&&o.push(F(m.name)),h&&f&&o.push(F(f.name)),o.length>0){const e=o.reduce((n,r)=>n.extend(r),new mapboxgl.LngLatBounds(o[0],o[0]));t.fitBounds(e,{padding:100})}}async function dt(){try{const t=document.querySelector(".btn-success"),o=t.innerHTML;t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Submitting...',t.disabled=!0;const e=N,n=e==="Straight";let r=n?"1":"0";const s=m&&m.ID===1/0;r+=s?"1":"0";let d=!1;n&&(d=f&&f.ID===1/0,r+=d?"1":"0");let u;s?u={name:m.name,coord:F(m.name,"start"),province:m.province||"Gauteng",address:m.address||m.name}:u={IDSource:m.ID};let b;n&&(d?b={nameDest:f.name,coordDest:F(f.name,"end"),provinceDest:f.province||"Gauteng",addressDest:f.address||f.name}:b={IDDest:f.ID});const I=[];E.forEach(_=>{I.push({message:`${e} route ${_.name} - Price: R${_.price}`,Coords:_.listOfCoords})}),i.length>0&&!w&&I.push({message:`${e} route ${x} (unfinished) - Price: R${parseFloat(document.getElementById("routePrice").value)||0}`,Coords:i});const k={price:parseFloat(document.getElementById("routePrice").value)||0,routeType:e,travelMethod:"Taxi",listOfMessAndCoords:I},R={caseType:r,TRSource:u,TRDest:b,routeInfo:k},T=await ae.post("/client//AddPendingRoute",R);(T.status===200||T.status===201)&&document.getElementById("successOverlay").classList.add("show")}catch(t){console.error("Error submitting route:",t),c("Error submitting route. Please try again.","error")}finally{const t=document.querySelector(".btn-success");t.innerHTML='<i class="fas fa-paper-plane"></i> Submit Route',t.disabled=!1}}function c(t,o="info"){const e=document.getElementById("messageContainer"),n=document.createElement("div");n.className=`message ${o}`,n.textContent=t,e.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},5e3)}function ut(){document.querySelector(".nav-links").classList.toggle("show")}function gt(){document.getElementById("successOverlay").classList.remove("show"),y=1,N=null,h=!0,E=[],D=1,x=1,p=null,L=null,H=v[0],w=!1,document.getElementById("startLocation").value="",document.getElementById("endLocation").value="",document.getElementById("routePrice").value="";const t=document.getElementById("endLocation");t&&(t.required=!0),W(),S&&S.remove(),A&&A.remove(),i=[],g=[],l=[],S=null,A=null,M=!1,document.querySelectorAll(".route-type-card").forEach(e=>{e.classList.remove("selected")}),document.getElementById("endLocationGroup").style.display="block";const o=document.querySelector(".addRoute");if(o){const e=o.querySelectorAll(".route_div");for(let n=1;n<e.length;n++)e[n].remove();e[0]&&(e[0].setAttribute("data-name","1"),e[0].style.backgroundColor=v[0],e[0].innerHTML=`
        Route 1
        <button class="routeButton" style="background-color: ${v[0]}" onclick="showRoute(1)">
          <i class="fa fa-eye" style="font-size: 12px; color: black;" aria-hidden="true"></i>
        </button>
        <button class="routeButton routeDeleteBtn" style="background-color: ${v[0]}" onclick="removeRoute(1)" disabled>
          <i class="fa fa-times" style="font-size: 12px; color: black;" aria-hidden="true"></i>
        </button>
      `)}V()}function mt(){window.location.href="/index.html"}window.nextStep=ue;window.previousStep=Te;window.selectRouteType=Ie;window.toggleDrawMode=me;window.finishRoute=Ne;window.clearRoute=W;window.createNewLocation=Ve;window.closeLocationModal=fe;window.saveNewLocation=st;window.submitRoute=dt;window.startNewRoute=gt;window.goToHome=mt;window.toggleMobileMenu=ut;window.topNavZIndexDecrease=function(){const t=document.querySelector(".topnav");t&&(t.style.zIndex="3")};window.addNewRoute=ot;window.showRoute=pe;window.removeRoute=rt;window.openRemoveRouteMenu=Ze;document.addEventListener("DOMContentLoaded",()=>{ve()});
