import{B as f}from"./AddressSelection-CWIIN_Gi.js";/* empty css              */import{t as T,l as q}from"./adminCommon-B1qRNhTn.js";import{r as A}from"./logout-DBLdyFVo.js";import{a as v}from"./axios-D4YhIzwJ.js";window.toggleAdminMobileMenu=T;window.logout=q;document.addEventListener("DOMContentLoaded",()=>{A()});let m=null;mapboxgl.accessToken="pk.eyJ1IjoiY2xpZXRpbiIsImEiOiJjbTR6eW1icmMxN3dyMmpzODBsZDQwNHN6In0.m5MSK2_0_SFpPPhB5BX86w";const c=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v11",center:[30,-25],zoom:12});c.fitBounds([[18.13518613880771,-34.966345196944445],[33.105929612928605,-22.069255932789716]]);let y=[],g=-1;const I=document.querySelector(".button.add"),L=document.querySelector(".menu_wrapper"),N=document.querySelector("#close_button"),$=document.querySelector("#update_button"),h=document.querySelector(".input_line.address textarea"),E=document.getElementById("suggestions"),S=document.querySelector(".input_line.prov input"),M=document.querySelector(".input_line.name input");document.querySelector("#ui_container");const B=document.querySelector(".menu.deleting"),j=document.querySelector(".btn.deleting"),F=document.querySelector(".menu.editing"),O=document.querySelector("#del_close_button"),Z=document.querySelector("#editing_close_button"),w=document.querySelector(".grid-table"),z=document.querySelector(".grid-row-container"),u={name:"",coord:{longitude:"",latitude:""},province:"",address:""};let _=0;async function H(t){if(!t){E.innerHTML="";return}const e=`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(t)}.json?access_token=${mapboxgl.accessToken}&country=ZA&autocomplete=true&limit=5`;try{const a=await(await fetch(e)).json();E.innerHTML="",a.features.length>0&&a.features.forEach(r=>{const n=document.createElement("li");n.textContent=r.place_name,n.style.padding="10px",n.style.cursor="pointer",n.addEventListener("click",()=>{const[s,d]=r.center;console.log("Selected coordinates:",s,d),u.coord.longitude=s,u.coord.latitude=d,m&&(m.remove(),console.log("marker is removed")),m=new mapboxgl.Marker().setLngLat([s,d]).addTo(c),c.flyTo({center:[s,d],zoom:12}),h.value=r.place_name,u.address=r.place_name,E.innerHTML=""}),E.appendChild(n)})}catch(o){console.error("Error fetching suggestions:",o)}}c.on("load",()=>{c.on("click",async t=>{const{lng:e,lat:o}=t.lngLat;console.log(`Coordinates clicked: Longitude - ${e}, Latitude - ${o}`);const a=`https://api.mapbox.com/geocoding/v5/mapbox.places/${e},${o}.json?access_token=${mapboxgl.accessToken}&country=ZA`;try{const n=await(await fetch(a)).json();if(n.features&&n.features.length>0){const s=n.features[0].place_name;console.log(`Address: ${s}`),u.coord.longitude=e,u.coord.latitude=o,u.address=s,m&&(m.remove(),console.log("Attempt to remove",m)),console.log("CurrentMarker : "+m),m=new mapboxgl.Marker().setLngLat([e,o]).addTo(c),h.value=s}else console.error("No address found for the clicked location.")}catch(r){console.error("Error fetching address:",r)}}),w.addEventListener("click",async t=>{const e=t.target.closest(".grid-row");if(e){X(),K();const o=e.dataset.rank,r=(await v.post(`${f}/admin/getTaxiRank`,{rankID:o})).data,n=R(r.taxiR_location_coords.longitude,r.taxiR_location_coords.latitude,"yellow");y.push(n);const s=r.route_coordsList;if(s.forEach(d=>{D(d.coords,d.travelMethod)}),s){let d=[];s.forEach(i=>{d.push(i.coords)});{const i=d.flat();G(i)}}}})});O.addEventListener("click",()=>{B.style.visibility="hidden",g=-1});Z.addEventListener("click",()=>{F.style.visibility="hidden"});h.addEventListener("input",t=>{H(t.target.value)});I&&L&&N&&$&&h&&M&&S?(I.addEventListener("click",t=>{L.style.visibility="visible"}),N.addEventListener("click",t=>{L.style.visibility="hidden"}),$.addEventListener("click",t=>{u.name=M.value,u.province=S.value,fetch(`${f}/admin/addTaxiRank`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}).then(e=>{if(!e.ok)throw new Error("Network response was not ok");return h.value="",S.value="",M.value="",P(),e.json()}).then(e=>{console.log("Server response:",e)}).catch(e=>{console.error("Error:",e)})})):console.error("Button or menu element not found.");W();async function W(){if(w)try{(await v.get(`${f}/admin/listTaxiRanks`)).data.forEach(async o=>{J(o.ID,o.name,o.province,o.address,o.num_routes);const a=R(o.coord.longitude,o.coord.latitude,"red");y.push(a),await U(o.ID)})}catch(t){console.error(t)}else console.error("An element not found under table list.")}function J(t,e,o,a,r){const n=document.createElement("div");n.className="grid-row",n.dataset.rank=t;const s=document.createElement("div");s.className="grid-cell",s.textContent=e,n.appendChild(s);const d=document.createElement("div");d.className="grid-cell",d.textContent=o,n.appendChild(d);const i=document.createElement("div");i.className="grid-cell",i.textContent=a,n.appendChild(i);const p=document.createElement("div");p.className="grid-cell",p.textContent=r;const l=document.createElement("div");l.id="multi_button";const k=document.createElement("button");k.className="btn route",k.textContent="Add route",k.dataset.rank=t,l.appendChild(k);const b=document.createElement("div");b.className="sub_multi_button";const x=document.createElement("button");x.className="btn edit",x.textContent="Edit";const C=document.createElement("button");C.className="btn del",C.textContent="Del",C.dataset.rank=t,b.appendChild(x),b.appendChild(C),l.appendChild(b),p.appendChild(l),n.appendChild(p),z.appendChild(n)}async function P(){if(w)try{const e=(await v.get(`${f}/admin/listTaxiRanks`)).data,o=e.length-1,a=e[o],r=document.createElement("div");r.className="grid-row",r.id="2";const n=document.createElement("div");n.className="grid-cell",n.textContent=a.name;const s=document.createElement("div");s.className="grid-cell",s.textContent=a.province;const d=document.createElement("div");d.className="grid-cell",d.textContent=a.address;const i=document.createElement("div");i.className="grid-cell fourth",i.textContent=a.num_routes;const p=document.createElement("span"),l=document.createElement("button");l.className="button route",l.textContent="Add Route",l.dataset.rank=a.ID,p.appendChild(l),i.appendChild(p),r.appendChild(n),r.appendChild(s),r.appendChild(d),r.appendChild(i),w.appendChild(r),R(a.coord.longitude,a.coord.latitude,"red")}catch(t){console.error(t)}else console.error("An element not found under table list.")}function R(t,e,o){return new mapboxgl.Marker({color:o,scale:.6}).setLngLat([t,e]).addTo(c)}function D(t,e){const o=`route-source-${_}`,a=`route-line-${_}`;_++,c.getSource(o)&&c.removeSource(o),c.getLayer(a)&&c.removeLayer(a);const r={type:"Feature",properties:{},geometry:{type:"LineString",coordinates:t}};c.addSource(o,{type:"geojson",data:{type:"FeatureCollection",features:[r]}});let n;e==="Walk"?n={"line-color":"#FF0000","line-width":4,"line-dasharray":[0,2]}:n={"line-color":"blue","line-width":4},c.addLayer({id:a,type:"line",source:o,layout:{"line-cap":"round","line-join":"round"},paint:n})}async function U(t){try{(await v.post(`${f}/admin/getTaxiRank`,{rankID:t})).data.route_coordsList.forEach(r=>{D(r.coords,r.travelMethod)})}catch(e){console.log(e)}}function G(t){const e=t.reduce((o,a)=>o.extend(a),new mapboxgl.LngLatBounds(t[0],t[0]));c.fitBounds(e,{padding:50,maxZoom:15,duration:2e3})}function X(){y.length>0&&(y.forEach(t=>{t.remove()}),y=[])}function K(){if(!c.getStyle()||!c.getStyle().layers)return;c.getStyle().layers.map(e=>e.id).forEach(e=>{e.startsWith("route-line-")&&c.removeLayer(e)}),Object.keys(c.getStyle().sources).forEach(e=>{e.startsWith("route-source-")&&c.removeSource(e)})}document.body.addEventListener("click",async function(t){if(t.target.classList.contains("route")){const e=t.target.dataset.rank;console.log("Button clicked for Taxi Rank ID:",e),window.location.href=`/pages/admin/route.html?rank=${e}`}if(t.target.classList.contains("del")){const e=t.target.dataset.rank;B.style.visibility="visible",g=e}});j.addEventListener("click",async t=>{if(g<0)return;console.log("delRankID : ",g);const e=await v.post(`${f}/admin/deleteTaxiRank`,{taxiRankID:g});console.log(e),e.status===200&&(g=-1,B.style.visibility="hidden")});document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".btn.route");console.log(t),t.forEach(e=>{console.log("Checking button"),e.addEventListener("click",function(){const o=this.getAttribute("data-rank");console.log("Button selected with RankID: "+o),window.location.href=`/pages/admin/route.html?rank=${o}`})})});
