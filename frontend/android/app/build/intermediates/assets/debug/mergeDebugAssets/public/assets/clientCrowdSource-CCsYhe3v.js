var Ke=Object.defineProperty;var We=(e,t,o)=>t in e?Ke(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var L=(e,t,o)=>We(e,typeof t!="symbol"?t+"":t,o);import{B as Ue}from"./AddressSelection-CWIIN_Gi.js";import{r as Ye}from"./logout-DBLdyFVo.js";import{a as be}from"./axios-D4YhIzwJ.js";import{p as v}from"./popup-CwFhKe62.js";document.addEventListener("DOMContentLoaded",()=>{Ye()});const J=be.create({withCredentials:!0,baseURL:Ue}),Ee=be.create({withCredentials:!1});J.interceptors.response.use(e=>e,e=>{if(e.response&&(e.response.status===401||e.response.status===403)){console.log("Session expired detected by interceptor"),localStorage.removeItem("userProfile"),localStorage.removeItem("activityLog");const t=document.getElementById("messageContainer");if(t){const o=document.createElement("div");o.className="message error",o.textContent="Session expired. Redirecting to home page...",t.appendChild(o)}setTimeout(()=>{window.location.href="/index.html"},2e3)}return Promise.reject(e)});const Me=document.querySelector("#routeId"),le=document.querySelector(".taxiRInput_container"),Ze=document.getElementById("routeType"),Je=document.querySelector(".inputcontainer.startingInput ul"),Ie=document.querySelector(".inputcontainer.destInput ul"),G=document.querySelector(".inputcontainer.startingInput input"),V=document.querySelector(".inputcontainer.destInput input"),Ge=document.querySelector(".group1 button"),Ve=document.querySelector(".group2 button"),ie=document.querySelector(".draw_flag"),we=document.querySelector(".draw_flag span"),Xe=document.querySelector(".saveSession"),Te=document.querySelector(".routeInfoContainerCover"),Be=document.querySelector(".sessionInfoContainerCover"),Qe=document.querySelector(".sessionInfoContainerCover i"),et=document.querySelector(".sendBtn"),me=document.querySelector(".menu_wrapper"),tt=document.querySelector("#close_button"),ot=document.querySelector("#update_button"),N=document.querySelector(".input_line.address textarea"),$=document.querySelector(".input_line.name input"),Y=document.querySelector(".input_line.prov input"),D=document.getElementById("suggestions"),Ae=document.querySelector(".menu.finalMarker"),nt=document.querySelector(".menu.finalMarker .close_button"),rt=document.querySelector(".menu.finalMarker .btn.yes"),st=document.querySelector(".menu.finalMarker .btn.no"),Pe=document.querySelector(".menu.editMarker"),it=document.querySelector(".menu.editMarker .close_button"),lt=document.querySelector(".menu.editMarker .btn.yes"),at=document.querySelector(".menu.editMarker .btn.no"),_e=document.querySelector(".menu.newSession"),ut=document.querySelector(".menu.newSession .close_button"),ct=document.querySelector(".menu.newSession .btn.yes"),dt=document.querySelector(".menu.newSession .btn.no"),qe=document.querySelector(".menu.clearRoute"),gt=document.querySelector(".menu.clearRoute .close_button"),ft=document.querySelector(".menu.clearRoute .btn.yes"),mt=document.querySelector(".menu.clearRoute .btn.no"),$e=document.querySelector(".menu.removeRoute"),pt=document.querySelector(".menu.removeRoute .btn.no"),ht=document.querySelector(".menu.removeRoute .btn.yes"),De=document.querySelector(".listmenu"),vt=document.querySelector(".listmenu .close_button"),yt=document.querySelector(".btnMenu.Edit"),Lt=document.querySelector(".btnMenu.Remove"),X=document.getElementById("priceRange"),oe=document.getElementById("selectedPrice"),x=document.querySelector(".routeInfoContainer textarea");document.querySelector(".routeButton i");document.querySelector(".route_div");const Rt=document.querySelector(".add_button");class ne{constructor(t){L(this,"name");L(this,"listOfCoords",[]);L(this,"message");L(this,"routeMarkers",[]);L(this,"coords",[]);L(this,"isLoopRoutefinished");this.name=t}hasRouteEnded(t){this.isLoopRoutefinished=t}AddMessage(t){this.message=t}AddListofMarkers(t){return t.length===0?!1:(this.routeMarkers.push(...t),!0)}AddCoords(t){return t.length===0?!1:(this.coords.push(...t),!0)}AddRouteCoords(t){return t.length===0?!1:(this.listOfCoords.push(...t),!0)}RoutePrint(){return` name: ${this.name} , message : ${this.message} , listOfCoords : ${this.listOfCoords}`}}class ae{constructor(t,o,n,a,r,l,c,d){L(this,"ID",1/0);L(this,"name");L(this,"province");L(this,"address");L(this,"num_routes");L(this,"isNew");L(this,"coord",{longitude:1/0,latitude:1/0});this.name=t,this.province=o,this.address=n,this.num_routes=a,this.coord.longitude=r,this.coord.latitude=l,this.isNew=c,c===!1&&(this.ID=d)}TaxiRankPrint(){return`ID: ${this.ID}  , name: ${this.name} , province: ${this.province} , address: ${this.address} , num_routes: ${this.num_routes} , isNew: ${this.isNew} , coord_longitude: ${this.coord.longitude} , coord_latitude: ${this.coord.latitude} `}}let k=new ne("1"),p=null,s=[],u=[],j=!1,R=!0,g=[],I=[],M=!1,pe=1,y=!1,T=!0,he=["#EBA9B7","#BCF9F9","#F9E1BC","#C1F9BC","#A9C6EB"],H=he[0],re=1,z=null,Q=null,S=null,K=null,C=null,Z=1,de=!1,se=[],f=null,m=null,b=null,E=null,A={startingTR:!1,destTR:!1},h={none:!0,starting:!1,dest:!1};const O="pk.eyJ1IjoiY2xpZXRpbiIsImEiOiJjbTR6eW1icmMxN3dyMmpzODBsZDQwNHN6In0.m5MSK2_0_SFpPPhB5BX86w";mapboxgl.accessToken=O;const i=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v11",center:[30,-25],zoom:12});i.on("load",()=>{i.on("click",async e=>{var a;const t=[e.lngLat.lng,e.lngLat.lat],o=t[0],n=t[1];if(P()&&M===!0&&(j=!0),h.starting===!0||h.dest===!0){const r=`https://api.mapbox.com/geocoding/v5/mapbox.places/${o},${n}.json?access_token=${O}&country=ZA`;try{const c=(a=(await Ee.get(r)).data.features[0])==null?void 0:a.place_name;console.log("Address:",c),h.starting===!0?(f&&(f.remove(),console.log("marker is removed")),ce()&&te(),f=new mapboxgl.Marker({color:"green"}).setLngLat([o,n]).addTo(i),i.flyTo({center:[o,n],zoom:12}),ue(0,[o,n])||s.push([o,n]),W(f,async d=>{d.stopPropagation(),P()&&M===!0&&(T=!0,U())}),N.value=c,D.innerHTML="",console.log("starting is clicked , coords array : ",s)):h.dest===!0&&(m&&(m.remove(),console.log("marker is removed")),ce()&&te(),m=new mapboxgl.Marker({color:"red"}).setLngLat([o,n]).addTo(i),i.flyTo({center:[o,n],zoom:12}),ue(1,[o,n])||(s[1]=[o,n]),W(m,async d=>{d.stopPropagation(),P()&&M===!0&&(U(),T=!1)}),N.value=c,D.innerHTML="",console.log("dest is clicked , coords array : ",s))}catch(l){return console.error("Error:",l),null}}else if(j){if(y){v.showSuccessPopup("The route has ended",!1);return}s.push(t);let r,l;if(s.length===2?(r=s[0],l=s[1],R===!1&&(u.length=0,u.push(r))):s.length===3&&R===!0?(r=s[0],l=s[2],u.length=0,u.push(r)):(s.length>3||s.length===3&&R===!1)&&(r=s[s.length-2],l=s[s.length-1]),r&&l){const d=`https://api.mapbox.com/directions/v5/mapbox/driving/${`${r.join(",")};${l.join(",")}`}?geometries=geojson&access_token=${O}`,w=(await(await fetch(d)).json()).routes[0].geometry;s.length===3||s.length===2&&R===!1?u.push(...w.coordinates.slice(1)):s.length>3&&u.push(...w.coordinates.slice(1)),F({type:"LineString",coordinates:u}),fe(t),p!==null&&(p=null)}f&&console.log("Coords starting marker : ",[f.getLngLat().lng,f.getLngLat().lat]),m&&console.log("Coords ending marker : ",[m.getLngLat().lng,m.getLngLat().lat]),g.length>0&&console.log("routeMarkers : ",g),console.log("Coords array : ",s)}}),i.on("contextmenu",e=>{e.preventDefault(),j&&g.length>0&&Mt()})});Ze.addEventListener("change",function(){const e=this.value;e==="Straight"?(de===!0&&(Pt(),de=!1),R=!0):e==="Loop"&&(de=!0,At(),m&&(m.remove(),console.log("marker is removed")),R=!1)});document.body.addEventListener("click",function(e){const t=e.target.closest(".routeButton i"),o=e.target.closest(".route_div");if(t&&o){const n=o.dataset.name;if(re!==Number(n))It(n),z=n;else{v.showSuccessPopup("Could not cancel route "+n+" , it is the current route",!1);return}}else if(o){const n=o.dataset.name;console.log(`Clicked route button for Route ${n}`),Ne(n)}});it.addEventListener("click",()=>{ve()});at.addEventListener("click",()=>{ve()});lt.addEventListener("click",()=>{Ht()});ut.addEventListener("click",()=>{Re()});dt.addEventListener("click",()=>{Re()});ct.addEventListener("click",()=>{Oe(),Re()});gt.addEventListener("click",()=>{Se()});mt.addEventListener("click",()=>{Se()});ft.addEventListener("click",()=>{Tt(),Se()});const St=document.getElementById("removeRoute_close_button");St.addEventListener("click",()=>{Ce()});pt.addEventListener("click",()=>{Ce()});ht.addEventListener("click",()=>{z!==null&&(Ct(z),console.log("Clicked route data-name:",z),Ne(re),Ce())});X.addEventListener("input",function(){oe.textContent=X.value});le.addEventListener("input",e=>{e.target.matches(".inputTR.group2 input")&&(se.length===0&&xe(),ke(e.target.value,!1))});G.addEventListener("input",()=>{se.length===0&&xe(),ke(G.value,!0)});Ge.addEventListener("click",()=>{if(me.style.visibility="visible",h.starting=!0,h.none=!1,h.dest=!1,window.innerWidth<=768){const e=document.getElementById("ui_container"),t=document.getElementById("sidebarToggle");e&&t&&(e.classList.remove("sidebar-open"),t.classList.remove("hidden"))}});Ve.addEventListener("click",()=>{if(me.style.visibility="visible",h.starting=!1,h.none=!1,h.dest=!0,window.innerWidth<=768){const e=document.getElementById("ui_container"),t=document.getElementById("sidebarToggle");e&&t&&(e.classList.remove("sidebar-open"),t.classList.remove("hidden"))}});Qe.addEventListener("click",()=>{Et()});Xe.addEventListener("click",()=>{if(!P()){v.showSuccessPopup("Could not save, please make sure you have inserted the price and the Markers are placed",!1);return}if(M=!0,ee(!0),Be.style.visibility="visible",Te.style.visibility="hidden",window.innerWidth<=768){const e=document.getElementById("ui_container"),t=document.getElementById("sidebarToggle");e&&t&&(e.classList.remove("sidebar-open"),t.classList.remove("hidden"))}});nt.addEventListener("click",()=>{Le()});rt.addEventListener("click",()=>{je(),Le()});st.addEventListener("click",()=>{je(),Le()});tt.addEventListener("click",e=>{ze()});ot.addEventListener("click",async e=>{var t;try{if(h.starting===!0||h.dest===!0){if(N.value.trim()==="")return console.log("Adress is empty"),null;const o=s[s.length-1],n=`https://api.mapbox.com/geocoding/v5/mapbox.places/${o[0]},${o[1]}.json?access_token=${O}&country=ZA`,r=(t=(await Ee.get(n)).data.features[0])==null?void 0:t.place_name;console.log("Address:",r),h.starting===!0?$.value.trim()!==""&&Y.value.trim()!==""?(b=new ae($.value,Y.value,r,1,o[0],o[1],!0),G.value=$.value,A.startingTR=!1):(console.log("Could not save TaxiRank"),v.showSuccessPopup("Please fill all inputs",!1)):h.dest===!0?$.value.trim()!==""&&Y.value.trim()!==""?(E=new ae($.value,Y.value,r,1,o[0],o[1],!0),V.value=$.value,A.destTR=!1):(console.log("Could not save TaxiRank"),v.showSuccessPopup("Please fill all inputs",!1)):console.log("Could not save TaxiRank"),ze()}}catch(o){return console.log(o),null}});N.addEventListener("input",e=>{_t(e.target.value)});Rt.addEventListener("click",()=>{if(y===!1){v.showSuccessPopup("Complete the current route first",!1);return}if(Fe()===!0){console.log("*****SAVED routes : *****",JSON.stringify(k.listOfCoords)),console.log("current routeCoords : ",u),ge();const t=qt();k=new ne(`${t}`),H=he[t-1],$t(`Route${t}`,H,t),re=t,pe++,y=!1,p=null,ee(!0)}else return console.log("Route object is null"),null});et.addEventListener("click",async()=>{if(y===!1){v.showSuccessPopup("Complete the current route first",!1);return}Fe()===!1&&console.log("ERROR: Last route was not saved!!"),console.log("SourceTaxiRank : ",b.TaxiRankPrint()),R===!0&&console.log("DestTaxiRank : ",E.TaxiRankPrint()),console.log("Routes : "),I.forEach(d=>{console.log(d.RoutePrint())});let t,o,n,a,r;R===!0?(o="1",t="Straight"):(o="0",t="Loop"),b.ID===1/0?(o+="1",n={name:b.name,coord:b.coord,province:b.province,address:b.address}):(o+="0",n={IDSource:b.ID}),R===!0&&(E.ID===1/0?(o+="1",a={nameDest:E.name,coordDest:E.coord,provinceDest:E.province,addressDest:E.address}):(o+="0",a={IDDest:E.ID}));let l=[];I.forEach(d=>{l.push({message:d.message,Coords:d.listOfCoords})}),r={price:parseInt(oe.textContent,10),routeType:t,travelMethod:"Taxi",listOfMessAndCoords:l};try{let d;R===!0?d=await J.post("/client//AddPendingRoute",{caseType:o,TRSource:n,TRDest:a,routeInfo:r}):d=await J.post("/client//AddPendingRoute",{caseType:o,TRSource:n,TRDest:a,routeInfo:r}),d.status!=200?v.showSuccessPopup("Could not save",!1):(v.showSuccessPopup("Route information saved!!",!0),await xt("suggestion","Route suggestion submitted",`Submitted ${t} route suggestion with ${I.length} segments`),Oe())}catch(d){console.log(d);return}});vt.addEventListener("click",()=>{ye(!1)});yt.addEventListener("click",()=>{if(!C){v.showSuccessPopup("Could not edit route ",!1);return}Nt(C)});Lt.addEventListener("click",e=>{if(console.log("coords before removal : ",s),console.log("routeCoordinates before : ",u),console.log("routeMarkers before : ",g),!K){v.showSuccessPopup("Could not remove route ",!1);return}Dt(K),console.log("coords after removal : ",s),console.log("routeCoordinates after : ",u),console.log("routeMarkers after : ",g)});function Ct(e){let t=-1;if(I.forEach((o,n)=>{o.name===`${e}`&&(t=n)}),t!==-1){I.splice(t,1);let o=document.querySelector(`.route_div[data-name="${e}"]`);o&&o.remove()}else console.log("ERROR: Could not find the route")}function kt(){const e=navigator.userAgent;return/Mobile|Android|iPhone|iPad/.test(e)?/iPhone/.test(e)?"iPhone":/Android/.test(e)?"Android":"Mobile Device":/Windows/.test(e)?"Windows":/Mac/.test(e)?"Mac":/Linux/.test(e)?"Linux":"Desktop"}async function xt(e,t,o){try{await J.post("/auth/activities",{activity_type:e,activity_title:t,activity_description:o,ip_address:null,user_agent:navigator.userAgent,device_info:kt(),location_info:null})}catch(n){console.error("Error logging activity:",n)}}function Ne(e){if(re==e){p!==null&&(ge(),s.push(...p.coords),y=p.isLoopRoutefinished,g.push(...p.routeMarkers),u.push(...p.listOfCoords),x.value=p.message,console.log("Coords : ",s),console.log("routeMarkers : ",g),console.log("routeCoordinates : ",u),g.forEach(t=>{t&&fe([t.getLngLat().lng,t.getLngLat().lat])}),F({type:"LineString",coordinates:p.listOfCoords}));return}if(p===null&&Bt()===!1){console.log("ERROR: Could not save unfinished route");return}I.forEach(t=>{t.name===`${e}`&&(ge(),console.log("New route : ",JSON.stringify(t.listOfCoords)),s.push(...t.coords),y=t.isLoopRoutefinished,g.push(...t.routeMarkers),u.push(...t.listOfCoords),x.value=t.message,console.log("Coords : ",s),console.log("routeMarkers : ",g),console.log("routeCoordinates : ",u),g.forEach(o=>{o&&fe([o.getLngLat().lng,o.getLngLat().lat])}),F({type:"LineString",coordinates:t.listOfCoords}))})}function wt(){Pe.style.visibility="visible"}function ve(){Pe.style.visibility="hidden"}function bt(){De.style.visibility="visible"}function ye(e){De.style.visibility="hidden",K=null,e===!1&&(C=null)}function W(e,t){console.log("Checking Marker ! "),e&&e.getElement()&&e.getElement().addEventListener("click",t)}function U(){Ae.style.visibility="visible"}function Le(){Ae.style.visibility="hidden"}function Et(){_e.style.visibility="visible"}function Re(){_e.style.visibility="hidden"}function Mt(){qe.style.visibility="visible"}function Se(){qe.style.visibility="hidden"}function It(e){z=e;const t=document.getElementById("removeRouteMessage");t.textContent=`Do you want to remove the route Route ${e}?`,$e.style.visibility="visible"}function Ce(){$e.style.visibility="hidden",z=null}function Tt(){i.getLayer("route")&&i.removeLayer("route"),i.getSource("route")&&i.removeSource("route"),["routeBehind","routeFoward"].forEach(t=>{i.getLayer(t)&&i.removeLayer(t),i.getSource(t)&&i.removeSource(t)}),g.forEach(t=>{t&&t.remove()}),g.length=0,u.length=0,R?s.length=2:s.length=1,y=!1,j=!1,oe.textContent="0",X&&(X.value="0"),p!==null&&(p=null),k=new ne("1"),x&&(x.value=""),Q=null,K=null,C=null,T=!0,M=!1,S&&(S.remove(),S=null),v.showSuccessPopup("Current route cleared successfully!",!0),console.log("Route cleared - Current state:"),console.log("routeMarkers length:",g.length),console.log("routeCoordinates length:",u.length),console.log("coords length:",s.length),console.log("directionSession:",j),console.log("isLoopRoutefinished:",y),console.log("savedCurrentRouteObj:",p)}function Oe(){te(),k=new ne("1"),p=null,I=[],pe=1,re=1,Z=1,H=he[0],y=!1,M=!1,j=!1,Me.textContent="1",x.value="",oe.textContent="0",X.value="0";const e=document.querySelector(".addRoute");if(e){const t=e.querySelectorAll(".route_div");for(let o=1;o<t.length;o++)t[o].remove()}G.value="",V&&(V.value=""),ee(!1),Be.style.visibility="hidden",Te.style.visibility="visible",v.showSuccessPopup("New session created successfully!",!0)}function F(e){i.getSource("route")?i.getSource("route").setData(e):(i.addSource("route",{type:"geojson",data:e}),i.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":H,"line-width":4}}))}function Fe(){return k&&pe<5?!u||u.length===0?(console.log("routeCoordinates has no coordinates"),v.showSuccessPopup("There is no route drawn",!1),null):(k.AddRouteCoords(u)===!1&&console.log("*********ERROR: Could not add route  "),k.AddCoords(s)===!1&&console.log("*********ERROR: Could not add all Marker (a.k.a coords)  "),k.AddListofMarkers(g)===!1&&console.log("*********ERROR: Could not add innerMarkers"),k.hasRouteEnded(y),x.value.trim()===""?k.AddMessage(""):(k.AddMessage(x.value),x.value=""),I.push(k),!0):!1}function Bt(){return p=new ne("Unfinished"),!u||u.length===0?(console.log("routeCoordinates has no coordinates"),v.showSuccessPopup("There is no route drawn",!1),!1):p.AddRouteCoords(u)===!1?(console.log("*********ERROR: Could not add route  "),!1):p.AddCoords(s)===!1?(console.log("*********ERROR: Could not add all Marker (a.k.a coords)  "),!1):p.AddListofMarkers(g)===!1?(console.log("*********ERROR: Could not add innerMarkers"),!1):(p.hasRouteEnded(y),x.value.trim()===""?p.AddMessage(""):(p.AddMessage(x.value),x.value=""),!0)}function P(){let e=!1;return R===!0?m!=null&&f!=null&&(e=!0):f!=null&&(e=!0),e===!0&&parseInt(oe.textContent,10)>0}function At(){const e=document.querySelector(".inputTR.group2");e?(e.remove(),le.style.height="70px"):console.warn("Element .inputTR.group2 not found.")}function Pt(){const e=document.createElement("div");e.className="inputTR group2";const t=document.createElement("div");t.className="inputcontainer destInput";const o=document.createElement("input");o.placeholder="Search destination taxiRank...",o.title="Search for an existing taxi rank where the taxi will End.";const n=document.createElement("ul");t.appendChild(o),t.appendChild(n);const a=document.createElement("button");a.textContent="Create new TaxiRank",a.title="Create a new taxi rank location as the ending point if it does not already exist.",e.appendChild(t),e.appendChild(a),le.appendChild(e),le.style.height="120px",o.addEventListener("input",()=>{se.length===0&&xe(),ke(o.value,!1)}),V=o,Ie=n}function ke(e,t){let o,n;if(t?(o=Je,n=G,console.log("Strting section")):(o=Ie,n=V),o.innerHTML="",!e){o.style.display="none";return}const a=se.filter(r=>r.name.toLowerCase().includes(e.toLowerCase()));if(a.length===0){o.style.display="none";return}a.forEach(r=>{const l=document.createElement("li");l.textContent=r.name,l.style.padding="10px",l.style.cursor="pointer",l.addEventListener("click",()=>{n.value=r.name,o.style.display="none";const c=[r.coord.longitude,r.coord.latitude];ce()&&te(),t?(f&&(f.remove(),console.log("marker is removed")),f=new mapboxgl.Marker({color:"green"}).setLngLat(c).addTo(i),s[0]=c,i.flyTo({center:c,zoom:17}),W(f,async d=>{d.stopPropagation(),P()&&M===!0&&(T=!0,U())}),b=new ae(r.name,r.province,r.address,1,r.coord.longitude,r.coord.latitude,!1,r.ID)):(m&&(m.remove(),console.log("marker is removed")),m=new mapboxgl.Marker({color:"red"}).setLngLat(c).addTo(i),s[1]=c,i.flyTo({center:c,zoom:17}),W(m,async d=>{d.stopPropagation(),P()&&M===!0&&(U(),T=!1)}),E=new ae(r.name,r.province,r.address,1,r.coord.longitude,r.coord.latitude,!1,r.ID))}),o.appendChild(l),console.log(s)}),n.getBoundingClientRect(),o.style.display="block"}async function xe(){try{se=(await J.get("/admin/listTaxiRanks")).data}catch(e){console.error("Error fetching taxi ranks:",e)}}async function _t(e){if(!e){D.innerHTML="";return}const t=`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(e)}.json?access_token=${mapboxgl.accessToken}&country=ZA&autocomplete=true&limit=5`;try{const n=await(await fetch(t)).json();D.innerHTML="",n.features.length>0&&n.features.forEach(a=>{const r=document.createElement("li");r.textContent=a.place_name,r.style.padding="10px",r.style.cursor="pointer",r.addEventListener("click",()=>{const[l,c]=a.center;console.log("Selected coordinates:",l,c),ce()&&te(),h.starting===!0?(f&&(f.remove(),console.log("marker is removed")),f=new mapboxgl.Marker({color:"green"}).setLngLat([l,c]).addTo(i),i.flyTo({center:[l,c],zoom:12}),W(f,async d=>{d.stopPropagation(),P()&&M===!0&&(T=!0,U())}),A.startingTR=!0,ue(0,[l,c])||s.push([l,c]),N.value=a.place_name,D.innerHTML=""):h.dest===!0&&(m&&(m.remove(),console.log("marker is removed")),m=new mapboxgl.Marker({color:"red"}).setLngLat([l,c]).addTo(i),i.flyTo({center:[l,c],zoom:12}),W(m,async d=>{d.stopPropagation(),P()&&M===!0&&(U(),T=!1)}),A.destTR=!0,ue(1,[l,c])||(s[1]=[l,c]),N.value=a.place_name,D.innerHTML=""),console.log("Coords array : ",s)}),D.appendChild(r)})}catch(o){console.error("Error fetching suggestions:",o)}}async function je(){if(R===!0){if(T){console.log("Wrong Marker clicked");return}if(console.log("Destination Marker was clicked (Correct) "),s.length>=3){const e=s.length-1,t=m.getLngLat(),n=`https://api.mapbox.com/directions/v5/mapbox/driving/${`${s[e].join(",")};${[t.lng,t.lat].join(",")}`}?geometries=geojson&access_token=${O}`,l=(await(await fetch(n)).json()).routes[0].geometry;u.push(...l.coordinates.slice(1)),F({type:"LineString",coordinates:u}),y=!0,ee(!1)}else v.showSuccessPopup("There is no waypoint drawn",!1)}else{if(T===!1){console.log("Wrong Marker clicked");return}if(console.log("Starting Marker was clicked (Correct) "),s.length>=2){const e=s.length-1,t=f.getLngLat(),n=`https://api.mapbox.com/directions/v5/mapbox/driving/${`${s[e].join(",")};${[t.lng,t.lat].join(",")}`}?geometries=geojson&access_token=${O}`,l=(await(await fetch(n)).json()).routes[0].geometry;u.push(...l.coordinates.slice(1)),F({type:"LineString",coordinates:u}),y=!0,ee(!1)}else v.showSuccessPopup("There is no waypoint drawn",!1)}}function ue(e,t){return s.length===0?!1:e>=0&&e<s.length?(s[e]=t,console.log("coords replication",s),!0):!1}function ee(e){e===!0?(ie.style.backgroundColor="#0AFF375c",ie.classList.add("on"),we.textContent="ON"):(ie.classList.add("off"),ie.style.backgroundColor="#FF0A0A5c",we.textContent="OFF")}function ge(){i.getLayer("route")&&i.removeLayer("route"),i.getSource("route")&&i.removeSource("route"),g.forEach(e=>{e&&e.remove()}),R===!0?s.length=2:s.length=1,g.length=0,u.length=0}function te(){i.getLayer("route")&&i.removeLayer("route"),i.getSource("route")&&i.removeSource("route"),f&&f.remove(),m&&m.remove(),g.forEach(e=>{e&&e.remove()}),s.length=0,g.length=0,u.length=0,b=null,E=null,I=[]}function fe(e){const t=document.createElement("div");t.style.width="10px",t.style.height="10px",t.style.borderRadius="50%",t.style.backgroundColor="blue",t.style.border="2px solid black";const o=new mapboxgl.Marker(t).setLngLat(e).addTo(i);g.push(o),o.coordIndex=s.length-1,o.routeStartingIndex=u.length-1,o.routeMarkerIndex=g.length-1,o.getElement().addEventListener("contextmenu",n=>{n.preventDefault(),n.stopPropagation(),K===null&&C===null&&(bt(),K=o,C=o)})}function ce(){return i.getSource("route")!==void 0&&i.getLayer("route")!==void 0}function qt(){return Z=Z+1,Me.textContent=`${Z}`,Z}function $t(e="Route1",t,o){const n=document.createElement("div");n.className="route_div",n.style.backgroundColor=t,n.setAttribute("data-name",o),n.textContent=e+" ";const a=document.createElement("button");a.style.backgroundColor=t,a.className="routeButton";const r=document.createElement("i");r.className="fa fa-times",r.style.fontSize="12px",r.style.color="black",r.setAttribute("aria-hidden","true"),a.appendChild(r),n.appendChild(a),document.querySelector(".addRoute").appendChild(n)}function ze(){me.style.visibility="hidden",$.value="",Y.value="",N.value="",h.starting=!1,h.none=!0,h.dest=!1,A.startingTR===!0&&(A.startingTR=!1,f&&f.remove()),A.destTR===!0&&(A.destTR=!1,m&&m.remove())}function Dt(e){const t=e.getLngLat(),o=e.routeStartingIndex,n=e.coordIndex,a=e.routeMarkerIndex;if(console.log("**MARKER** coordinates found : ",t),console.log("**MARKER** routeStartingIndex : ",o),console.log("**MARKER** coordIndex : ",n),console.log("**MARKER** routeMarkerIndex : ",a),i.getSource("route")){F({type:"LineString",coordinates:u.slice(0,o+1)});for(let l=a+1;l<g.length;l++){const c=g[l];c&&c.remove()}u=u.slice(0,o+1),s=s.slice(0,n+1),g.length=a+1,y===!0&&(y=!1)}ye(!1)}function Nt(e){const t=e.getLngLat(),o=e.routeStartingIndex,n=e.coordIndex;console.log("**MARKER** coordinates found : ",t),console.log("**MARKER** routeStartingIndex : ",o),console.log("**MARKER** coordIndex : ",n),Ot();const a=g.findIndex(w=>t.lng===w.getLngLat().lng&&t.lat===w.getLngLat().lat);if(a===-1){console.log("index is -1 ");return}let r=a-1;r<0&&(r=null);let l=a+1;l>=g.length&&(l=null);const c=r!==null?g[r]:null,d=l!==null?g[l]:null;console.log("markerBehind : ",c),console.log("markerFoward : ",d);let B;if(c===null?B=0:B=c.routeStartingIndex,console.log("startingIndex : ",B),console.log("routeCoordinates : ",u),B>=0){console.log("firdt index : ",0," startingIndex of markerBehind: ",B+1);const w=u.slice(0,B+1);jt(w,H)}else console.log("startingIndex : ",B);let _;if(d===null?_=u.length:_=d.routeStartingIndex,_>=0){console.log("indexOfCurrentMarker : ",o," endingIndex : ",_);const q=u.slice(_,u.length);zt(q,H)}else console.log("endingIndex : ",_);if(Q=c,console.log("globalMarkerBehind : ",Q),ye(!0),v.showSuccessPopup("click in a new area to edit the route",!0),!e._draggable){const w=e.getLngLat();e.getElement().style.display="none";const q=new mapboxgl.Marker({color:"orange",draggable:!0}).setLngLat(w).addTo(i);q.coordIndex=e.coordIndex,q.routeStartingIndex=e.routeStartingIndex,q.on("dragend",()=>{const He=q.getLngLat();console.log("Dragged and drobbed : ",He),S=q,wt()})}}function Ot(){i.getLayer("route")&&i.removeLayer("route"),i.getSource("route")&&i.removeSource("route")}function Ft(e,t,o,n,a){const r=t-e+1;return u.splice(e,r,...a),s[o]=n,console.log("Edit routeCoords 2 : ",...a),e+a.length-1}function jt(e,t){console.log("behind coords : ",e),i.addSource("routeBehind",{type:"geojson",data:{type:"LineString",coordinates:e}}),i.addLayer({id:"routeBehind",type:"line",source:"routeBehind",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":t,"line-width":4}})}function zt(e,t){console.log("foward coords : ",e),i.addSource("routeFoward",{type:"geojson",data:{type:"LineString",coordinates:e}}),i.addLayer({id:"routeFoward",type:"line",source:"routeFoward",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":t,"line-width":4}})}async function Ht(){let e;Q?e=Q:e=f,console.log("markerBehind in[recreateRouteAfterEdit]: ",e);const t=await Kt([e.getLngLat().lng,e.getLngLat().lat],[S.getLngLat().lng,S.getLngLat().lat]);console.log("Edit routeCoords 1 : ",t),console.log("Routes coord before : ",u);let o;e.routeStartingIndex?o=e.routeStartingIndex:o=0,console.log("StartingIndex : ",o);const n=Ft(o,C.routeStartingIndex,C.coordIndex,[S.getLngLat().lng,S.getLngLat().lat],t);console.log("Routes coord after : ",u),C.setLngLat([S.getLngLat().lng,S.getLngLat().lat]),C.routeStartingIndex=n,C.getElement().style.display="",Wt(),F({type:"LineString",coordinates:u}),console.log("markerChosenForEditing index in Coords : ",C.coordIndex),console.log("Coords : ",s),ve(),C=null,S&&(S.remove(),S=null)}async function Kt(e,t){const n=`https://api.mapbox.com/directions/v5/mapbox/driving/${`${e.join(",")};${t.join(",")}`}?geometries=geojson&access_token=${O}`;return(await(await fetch(n)).json()).routes[0].geometry.coordinates}function Wt(){["routeBehind","routeFoward"].forEach(t=>{i.getLayer(t)&&i.removeLayer(t),i.getSource(t)&&i.removeSource(t)}),console.log("Both routeBehind and routeFoward have been removed.")}
