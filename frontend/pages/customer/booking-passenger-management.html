<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Passengers - TeksiMap</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="icon" type="image/png" href="./favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="./favicon-32x32.png" sizes="32x32">
    <link rel="apple-touch-icon" href="./apple-touch-icon.svg">
    <link rel="manifest" href="../../assets/icons/site.webmanifest">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../css/topnav.css" />
    <link rel="stylesheet" href="../../css/booking.css">
    <link rel="stylesheet" href="../../css/clientStyle.css">
    <link rel="stylesheet" href="../../css/booking-passenger-management.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
      /* Auth buttons styling */
      .auth-buttons {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-left: auto;
        position: absolute;
        right: 2rem;
        top: 50%;
        transform: translateY(-50%);
      }
      
      .btn-login {
        background: transparent;
        color: white;
        border: 2px solid white;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        text-decoration: none;
        transition: all 0.3s ease;
      }
      
      .btn-login:hover {
        background: white;
        color: #333;
      }
      
      .btn-signup {
        background: #FFD700;
        color: #333;
        border: 2px solid #FFD700;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      
      .btn-signup:hover {
        background: transparent;
        color: white;
        border-color: white;
      }
      
      .full-navigation {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        margin-left: auto;
      }
      
      .full-navigation a {
        color: white;
        text-decoration: none;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        transition: all 0.3s ease;
      }
      
      .full-navigation a:hover {
        background-color: rgba(255, 255, 255, 0.1);
        text-decoration: none;
      }
      
      /* Logout Button Styling */
      .nav-logout-btn {
        background: #dc3545 !important;
        color: white !important;
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: 10px;
        white-space: nowrap;
      }
      
      .nav-logout-btn:hover {
        background: #c82333 !important;
        text-decoration: none !important;
        transform: translateY(-1px);
      }
      
      .nav-logout-btn i {
        font-size: 14px;
      }
      
      /* Ensure nav-container has relative positioning */
      .nav-container {
        position: relative;
      }
      
      @media (max-width: 768px) {
        .auth-buttons {
          position: static;
          transform: none;
          margin-left: 0;
          flex-direction: column;
          gap: 0.5rem;
          width: 100%;
          padding: 1rem 2rem;
        }
        
        .full-navigation {
          flex-direction: column;
          gap: 0.5rem;
          width: 100%;
          padding: 1rem 2rem;
        }
        
        .btn-login, .btn-signup {
          width: 100%;
          text-align: center;
          padding: 0.75rem 1rem;
          font-size: 1rem;
        }
      }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Top navigation bar -->
        <nav class="topnav">
            <div class="nav-container">
                <div class="logo">
                    <a href="../../index.html">
                        <img src="../../assets/icons/logo-advanced-white.svg" alt="TeksiMap Logo" class="h-10 w-auto" />
                    </a>
                </div>

                <!-- Burger button for mobile -->
                <div class="burger" onclick="toggleMobileMenu()">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>

                <!-- Navigation links -->
                <div class="nav-links" id="mobileMenu">
                    <a href="client.html" onclick="topNavZIndexDecrease()">Find route</a>
                    <a href="booking-type-selection.html" onclick="topNavZIndexDecrease()">Book Taxi</a>
                    <a href="help.html" onclick="topNavZIndexDecrease()">Help</a>
                    <!-- Login/Signup buttons for non-logged in users -->
                    <div id="authButtons" class="auth-buttons">
                        <a href="../authentication/login.html" class="btn-login">Login</a>
                        <a href="../authentication/signup.html" class="btn-signup">Sign Up</a>
                    </div>
                    <!-- Full navigation for logged in users -->
                    <div id="fullNav" class="full-navigation" style="display: none;">
                        <a href="route-suggestion.html" onclick="topNavZIndexDecrease()">Suggest route</a>
                        <a href="feedback.html" onclick="topNavZIndexDecrease()">Feedback</a>
                        <a href="../authentication/profile.html" onclick="topNavZIndexDecrease()">Profile</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="page-content">
            <div class="passenger-management-container">
                <!-- Header -->
                <div class="management-header">
                    <h1 class="management-title">Manage Passengers</h1>
                    <p class="management-subtitle">Add, edit, or remove passenger information</p>
                </div>

                <!-- Booking Information -->
                <div class="booking-info">
                    <h3>Booking Information</h3>
                    <div class="booking-details" id="bookingDetails">
                        <!-- Booking details will be loaded here -->
                    </div>
                </div>

                <!-- Capacity Information -->
                <div class="capacity-info" id="capacityInfo">
                    <!-- Capacity info will be loaded here -->
                </div>

                <!-- Passenger Management Form -->
                <div class="passenger-form">
                    <div class="form-section">
                        <h2>Passenger Details</h2>
                        <p class="section-description">Manage passenger information for this booking. You can add, edit, or remove passengers as needed.</p>
                        
                        <div id="passengerForms">
                            <!-- Passenger forms will be generated here -->
                        </div>
                        
                        <!-- Add Passenger Button -->
                        <div class="add-passenger-section" id="addPassengerSection">
                            <button type="button" class="btn btn-add" onclick="addPassenger()">
                                <i class="fas fa-plus"></i> Add Another Passenger
                            </button>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">
                            <i class="fas fa-arrow-left"></i> Back to Bookings
                        </button>
                        <button type="button" class="btn btn-primary" onclick="savePassengers()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="../../js/tonav.js"></script>
    <script type="module" src="../../js/authentication/logout.js"></script>
    <script>

        // Global variables for passenger management
        let currentBooking = null;
        let currentPassengerCount = 1;
        let maxPassengers = 1;
        let passengerData = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadBookingInfo();
            loadPassengerForms();
        });

        function loadBookingInfo() {
            currentBooking = JSON.parse(sessionStorage.getItem('currentBooking') || '{}');
            if (!currentBooking.id) {
                alert('No booking found. Redirecting to bookings page.');
                window.location.href = 'booking-trip-info.html';
                return;
            }
            
            console.log('Current Booking:', currentBooking); // Debug log
            
            // Display booking information
            const bookingDetails = document.getElementById('bookingDetails');
            bookingDetails.innerHTML = `
                <div class="detail-item">
                    <span class="detail-label">Vehicle</span>
                    <span class="detail-value">${currentBooking.vehicle.name}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">From</span>
                    <span class="detail-value">${currentBooking.trip.pickup}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">To</span>
                    <span class="detail-value">${currentBooking.trip.destination}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Date</span>
                    <span class="detail-value">${currentBooking.trip.date}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Time</span>
                    <span class="detail-value">${currentBooking.trip.time}</span>
                </div>
            `;
            
            // Set capacity limits
            maxPassengers = currentBooking.vehicle.capacity || 1;
            currentPassengerCount = currentBooking.passengers ? currentBooking.passengers.length : 0;
            
            // If no passengers exist, start with 1 empty passenger
            if (currentPassengerCount === 0) {
                currentPassengerCount = 1;
            }
            
            console.log('Max Passengers:', maxPassengers); // Debug log
            console.log('Current Passenger Count:', currentPassengerCount); // Debug log
            console.log('Existing Passengers:', currentBooking.passengers); // Debug log
            
            // Display capacity information
            const capacityInfo = document.getElementById('capacityInfo');
            capacityInfo.innerHTML = `
                <h3><i class="fas fa-info-circle"></i> Vehicle Capacity</h3>
                <p>This vehicle can accommodate up to ${maxPassengers} passengers. Current passengers: ${currentPassengerCount}/${maxPassengers}</p>
            `;
            
            // Update add passenger button visibility
            updateAddPassengerButton();
        }

        function loadPassengerForms() {
            console.log('Loading passenger forms...'); // Debug log
            console.log('Current booking passengers:', currentBooking.passengers); // Debug log
            console.log('Current passenger count from loadBookingInfo:', currentPassengerCount); // Debug log
            
            // Initialize passenger data from existing booking
            passengerData = {};
            if (currentBooking.passengers && currentBooking.passengers.length > 0) {
                console.log('Found existing passengers:', currentBooking.passengers.length); // Debug log
                currentBooking.passengers.forEach((passenger, index) => {
                    passengerData[index + 1] = {
                        firstName: passenger.firstName || '',
                        lastName: passenger.lastName || '',
                        idNumber: passenger.idNumber || '',
                        phone: passenger.phone || ''
                    };
                });
                // Don't override currentPassengerCount here, use what was set in loadBookingInfo
            } else {
                console.log('No existing passengers, initializing with 1'); // Debug log
                // Initialize with empty passenger
                passengerData[1] = {
                    firstName: '',
                    lastName: '',
                    idNumber: '',
                    phone: ''
                };
            }
            
            console.log('Final passenger count:', currentPassengerCount); // Debug log
            console.log('Final passenger data:', passengerData); // Debug log
            console.log('Max passengers:', maxPassengers); // Debug log
            
            // Update capacity info display
            updateCapacityInfo();
            generatePassengerForms();
            updateAddPassengerButton();
            
            console.log('Finished loading passenger forms'); // Debug log
        }

        function updateCapacityInfo() {
            const capacityInfo = document.getElementById('capacityInfo');
            capacityInfo.innerHTML = `
                <h3><i class="fas fa-info-circle"></i> Vehicle Capacity</h3>
                <p>This vehicle can accommodate up to ${maxPassengers} passengers. Current passengers: ${currentPassengerCount}/${maxPassengers}</p>
            `;
        }

        function generatePassengerForms() {
            const passengerForms = document.getElementById('passengerForms');
            passengerForms.innerHTML = '';
            
            for (let i = 1; i <= currentPassengerCount; i++) {
                // Ensure passenger data exists for this index
                if (!passengerData[i]) {
                    passengerData[i] = {
                        firstName: '',
                        lastName: '',
                        idNumber: '',
                        phone: ''
                    };
                }
                
                const passengerCard = document.createElement('div');
                passengerCard.className = 'passenger-card';
                
                passengerCard.innerHTML = `
                    <div class="passenger-card-header">
                        <div class="passenger-title-card">Passenger ${i}</div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="passenger-number">#${i}</div>
                            ${currentPassengerCount > 1 ? `<button type="button" class="btn btn-remove" onclick="removePassenger(${i})">
                                <i class="fas fa-times"></i> Remove
                            </button>` : ''}
                        </div>
                    </div>
                    <div class="passenger-fields">
                        <div class="input-group">
                            <label for="passenger${i}_firstName">First Name</label>
                            <input type="text" id="passenger${i}_firstName" name="passenger${i}_firstName" placeholder="Enter first name" value="${passengerData[i].firstName}" onchange="updatePassengerData(${i}, 'firstName', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="passenger${i}_lastName">Last Name</label>
                            <input type="text" id="passenger${i}_lastName" name="passenger${i}_lastName" placeholder="Enter last name" value="${passengerData[i].lastName}" onchange="updatePassengerData(${i}, 'lastName', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="passenger${i}_idNumber">ID Number</label>
                            <input type="text" id="passenger${i}_idNumber" name="passenger${i}_idNumber" placeholder="Enter ID number" value="${passengerData[i].idNumber}" onchange="updatePassengerData(${i}, 'idNumber', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="passenger${i}_phone">Phone Number</label>
                            <input type="tel" id="passenger${i}_phone" name="passenger${i}_phone" placeholder="Enter phone number" value="${passengerData[i].phone}" onchange="updatePassengerData(${i}, 'phone', this.value)">
                        </div>
                    </div>
                `;
                passengerForms.appendChild(passengerCard);
            }
        }

        function updatePassengerData(passengerIndex, field, value) {
            if (!passengerData[passengerIndex]) {
                passengerData[passengerIndex] = {
                    firstName: '',
                    lastName: '',
                    idNumber: '',
                    phone: ''
                };
            }
            passengerData[passengerIndex][field] = value;
        }

        function addPassenger() {
            if (currentPassengerCount < maxPassengers) {
                currentPassengerCount++;
                // Initialize data for the new passenger
                passengerData[currentPassengerCount] = {
                    firstName: '',
                    lastName: '',
                    idNumber: '',
                    phone: ''
                };
                updateCapacityInfo();
                generatePassengerForms();
                updateAddPassengerButton();
            }
        }

        function removePassenger(passengerNumber) {
            if (currentPassengerCount > 1) {
                // Remove the passenger data
                delete passengerData[passengerNumber];
                
                // Shift remaining passenger data down
                const newPassengerData = {};
                let newIndex = 1;
                for (let i = 1; i <= currentPassengerCount; i++) {
                    if (passengerData[i] && i !== passengerNumber) {
                        newPassengerData[newIndex] = passengerData[i];
                        newIndex++;
                    }
                }
                passengerData = newPassengerData;
                
                currentPassengerCount--;
                updateCapacityInfo();
                generatePassengerForms();
                updateAddPassengerButton();
            }
        }

        function updateAddPassengerButton() {
            const addPassengerSection = document.getElementById('addPassengerSection');
            console.log('Updating add passenger button...'); // Debug log
            console.log('Current passenger count:', currentPassengerCount); // Debug log
            console.log('Max passengers:', maxPassengers); // Debug log
            console.log('Should show button:', currentPassengerCount < maxPassengers); // Debug log
            
            if (currentPassengerCount < maxPassengers) {
                addPassengerSection.style.display = 'block';
                console.log('Showing add passenger button'); // Debug log
            } else {
                addPassengerSection.style.display = 'none';
                console.log('Hiding add passenger button'); // Debug log
            }
        }

        function savePassengers() {
            // Collect passenger data
            const passengers = [];
            for (let i = 1; i <= currentPassengerCount; i++) {
                if (passengerData[i]) {
                    const { firstName, lastName, idNumber, phone } = passengerData[i];
                    if (firstName || lastName || idNumber || phone) {
                        passengers.push({
                            firstName: firstName,
                            lastName: lastName,
                            idNumber: idNumber,
                            phone: phone
                        });
                    }
                }
            }
            
            // Update the booking with new passenger data
            currentBooking.passengers = passengers;
            
            // Save to appropriate storage based on booking status
            const bookingStatus = sessionStorage.getItem('currentBookingStatus');
            const bookingId = sessionStorage.getItem('currentBookingId');
            
            if (bookingStatus === 'pending') {
                const pendingBookings = JSON.parse(localStorage.getItem('pendingBookings') || '[]');
                const bookingIndex = pendingBookings.findIndex(b => b.id === bookingId);
                if (bookingIndex !== -1) {
                    pendingBookings[bookingIndex] = currentBooking;
                    localStorage.setItem('pendingBookings', JSON.stringify(pendingBookings));
                }
            } else if (bookingStatus === 'confirmed') {
                const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                const bookingIndex = confirmedBookings.findIndex(b => b.id === bookingId);
                if (bookingIndex !== -1) {
                    confirmedBookings[bookingIndex] = currentBooking;
                    localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                }
            }
            
            alert('Passenger information saved successfully!');
            window.location.href = 'booking-trip-info.html';
        }

        function goBack() {
            window.location.href = 'booking-trip-info.html';
        }
    </script>

</body>
</html>
