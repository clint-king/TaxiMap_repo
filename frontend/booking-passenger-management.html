<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Passengers - TeksiMap</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <link rel="icon" type="image/svg+xml" href="./favicon-16x16.svg" sizes="16x16">
    <link rel="icon" type="image/svg+xml" href="./favicon-32x32.svg" sizes="32x32">
    <link rel="apple-touch-icon" href="./apple-touch-icon.svg">
    <link rel="manifest" href="./site.webmanifest">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./css/booking.css">
    <link rel="stylesheet" href="./css/clientStyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        body, html {
            overflow: hidden;
            height: 100vh;
        }
        
        .page-content {
            height: calc(100vh - 80px);
            overflow: hidden;
        }
        
        .passenger-management-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            height: 100%;
            overflow-y: auto;
        }
        
        .management-header {
            background: linear-gradient(135deg, #01386A 0%, #025aa5 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(1, 56, 106, 0.3);
        }
        
        .management-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .management-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .booking-info {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .booking-info h3 {
            color: #01386A;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .booking-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }
        
        .detail-value {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        
        .passenger-form {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .form-section {
            margin-bottom: 2rem;
        }
        
        .form-section h2 {
            color: #01386A;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .section-description {
            color: #6c757d;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .passenger-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .passenger-card:hover {
            border-color: #01386A;
            box-shadow: 0 4px 12px rgba(1, 56, 106, 0.1);
        }
        
        .passenger-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .passenger-title-card {
            font-weight: 700;
            color: #01386A;
            font-size: 1.2rem;
        }
        
        .passenger-number {
            background: #01386A;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .passenger-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .input-group input {
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #01386A;
            box-shadow: 0 0 0 3px rgba(1, 56, 106, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e9ecef;
        }
        
        .btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #01386A 0%, #025aa5 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(1, 56, 106, 0.3);
        }
        
        .btn-add {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(40, 167, 69, 0.3);
        }
        
        .btn-remove {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
        }
        
        .btn-remove:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        
        .capacity-info {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .capacity-info h3 {
            color: #856404;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
        
        .capacity-info p {
            color: #856404;
            margin: 0;
            font-size: 0.95rem;
        }
        
        .add-passenger-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 768px) {
            .passenger-management-container {
                padding: 1rem;
            }
            
            .passenger-fields {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Top navigation bar -->
        <nav class="topnav">
            <div class="nav-container">
                <div class="logo">
                    <a href="index.html">
                        <img src="logo-advanced-white.svg" alt="TeksiMap Logo" class="h-10 w-auto" />
                    </a>
                </div>

                <!-- Burger button for mobile -->
                <div class="burger" onclick="toggleMobileMenu()">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>

                <!-- Navigation links -->
                <div class="nav-links" id="mobileMenu">
                    <a href="client.html" onclick="topNavZIndexDecrease()">Find route</a>
                    <a href="route-suggestion.html" onclick="topNavZIndexDecrease()">Suggest route</a>
                    <a href="booking-trip-info.html" class="active" onclick="topNavZIndexDecrease()">Book Taxi</a>
                    <a href="feedback.html" onclick="topNavZIndexDecrease()">Feedback</a>
                    <a href="profile.html" onclick="topNavZIndexDecrease()">Profile</a>
                    <a href="help.html" onclick="topNavZIndexDecrease()">Help</a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="page-content">
            <div class="passenger-management-container">
                <!-- Header -->
                <div class="management-header">
                    <h1 class="management-title">Manage Passengers</h1>
                    <p class="management-subtitle">Add, edit, or remove passenger information</p>
                </div>

                <!-- Booking Information -->
                <div class="booking-info">
                    <h3>Booking Information</h3>
                    <div class="booking-details" id="bookingDetails">
                        <!-- Booking details will be loaded here -->
                    </div>
                </div>

                <!-- Capacity Information -->
                <div class="capacity-info" id="capacityInfo">
                    <!-- Capacity info will be loaded here -->
                </div>

                <!-- Passenger Management Form -->
                <div class="passenger-form">
                    <div class="form-section">
                        <h2>Passenger Details</h2>
                        <p class="section-description">Manage passenger information for this booking. You can add, edit, or remove passengers as needed.</p>
                        
                        <div id="passengerForms">
                            <!-- Passenger forms will be generated here -->
                        </div>
                        
                        <!-- Add Passenger Button -->
                        <div class="add-passenger-section" id="addPassengerSection">
                            <button type="button" class="btn btn-add" onclick="addPassenger()">
                                <i class="fas fa-plus"></i> Add Another Passenger
                            </button>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">
                            <i class="fas fa-arrow-left"></i> Back to Bookings
                        </button>
                        <button type="button" class="btn btn-primary" onclick="savePassengers()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="./js/logout.js"></script>
    
    <script>
        // Navigation functions
        function toggleMobileMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('show');
        }

        function topNavZIndexDecrease() {
            const topnav = document.querySelector('.topnav');
            if (topnav) {
                topnav.style.zIndex = '999';
            }
        }

        // Global variables for passenger management
        let currentBooking = null;
        let currentPassengerCount = 1;
        let maxPassengers = 1;
        let passengerData = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadBookingInfo();
            loadPassengerForms();
        });

        function loadBookingInfo() {
            currentBooking = JSON.parse(sessionStorage.getItem('currentBooking') || '{}');
            if (!currentBooking.id) {
                alert('No booking found. Redirecting to bookings page.');
                window.location.href = 'booking-trip-info.html';
                return;
            }
            
            console.log('Current Booking:', currentBooking); // Debug log
            
            // Display booking information
            const bookingDetails = document.getElementById('bookingDetails');
            bookingDetails.innerHTML = `
                <div class="detail-item">
                    <span class="detail-label">Vehicle</span>
                    <span class="detail-value">${currentBooking.vehicle.name}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">From</span>
                    <span class="detail-value">${currentBooking.trip.pickup}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">To</span>
                    <span class="detail-value">${currentBooking.trip.destination}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Date</span>
                    <span class="detail-value">${currentBooking.trip.date}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Time</span>
                    <span class="detail-value">${currentBooking.trip.time}</span>
                </div>
            `;
            
            // Set capacity limits
            maxPassengers = currentBooking.vehicle.capacity || 1;
            currentPassengerCount = currentBooking.passengers ? currentBooking.passengers.length : 0;
            
            // If no passengers exist, start with 1 empty passenger
            if (currentPassengerCount === 0) {
                currentPassengerCount = 1;
            }
            
            console.log('Max Passengers:', maxPassengers); // Debug log
            console.log('Current Passenger Count:', currentPassengerCount); // Debug log
            console.log('Existing Passengers:', currentBooking.passengers); // Debug log
            
            // Display capacity information
            const capacityInfo = document.getElementById('capacityInfo');
            capacityInfo.innerHTML = `
                <h3><i class="fas fa-info-circle"></i> Vehicle Capacity</h3>
                <p>This vehicle can accommodate up to ${maxPassengers} passengers. Current passengers: ${currentPassengerCount}/${maxPassengers}</p>
            `;
            
            // Update add passenger button visibility
            updateAddPassengerButton();
        }

        function loadPassengerForms() {
            console.log('Loading passenger forms...'); // Debug log
            console.log('Current booking passengers:', currentBooking.passengers); // Debug log
            console.log('Current passenger count from loadBookingInfo:', currentPassengerCount); // Debug log
            
            // Initialize passenger data from existing booking
            passengerData = {};
            if (currentBooking.passengers && currentBooking.passengers.length > 0) {
                console.log('Found existing passengers:', currentBooking.passengers.length); // Debug log
                currentBooking.passengers.forEach((passenger, index) => {
                    passengerData[index + 1] = {
                        firstName: passenger.firstName || '',
                        lastName: passenger.lastName || '',
                        idNumber: passenger.idNumber || '',
                        phone: passenger.phone || ''
                    };
                });
                // Don't override currentPassengerCount here, use what was set in loadBookingInfo
            } else {
                console.log('No existing passengers, initializing with 1'); // Debug log
                // Initialize with empty passenger
                passengerData[1] = {
                    firstName: '',
                    lastName: '',
                    idNumber: '',
                    phone: ''
                };
            }
            
            console.log('Final passenger count:', currentPassengerCount); // Debug log
            console.log('Final passenger data:', passengerData); // Debug log
            console.log('Max passengers:', maxPassengers); // Debug log
            
            // Update capacity info display
            updateCapacityInfo();
            generatePassengerForms();
            updateAddPassengerButton();
            
            console.log('Finished loading passenger forms'); // Debug log
        }

        function updateCapacityInfo() {
            const capacityInfo = document.getElementById('capacityInfo');
            capacityInfo.innerHTML = `
                <h3><i class="fas fa-info-circle"></i> Vehicle Capacity</h3>
                <p>This vehicle can accommodate up to ${maxPassengers} passengers. Current passengers: ${currentPassengerCount}/${maxPassengers}</p>
            `;
        }

        function generatePassengerForms() {
            const passengerForms = document.getElementById('passengerForms');
            passengerForms.innerHTML = '';
            
            for (let i = 1; i <= currentPassengerCount; i++) {
                // Ensure passenger data exists for this index
                if (!passengerData[i]) {
                    passengerData[i] = {
                        firstName: '',
                        lastName: '',
                        idNumber: '',
                        phone: ''
                    };
                }
                
                const passengerCard = document.createElement('div');
                passengerCard.className = 'passenger-card';
                
                passengerCard.innerHTML = `
                    <div class="passenger-card-header">
                        <div class="passenger-title-card">Passenger ${i}</div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="passenger-number">#${i}</div>
                            ${currentPassengerCount > 1 ? `<button type="button" class="btn btn-remove" onclick="removePassenger(${i})">
                                <i class="fas fa-times"></i> Remove
                            </button>` : ''}
                        </div>
                    </div>
                    <div class="passenger-fields">
                        <div class="input-group">
                            <label for="passenger${i}_firstName">First Name</label>
                            <input type="text" id="passenger${i}_firstName" name="passenger${i}_firstName" placeholder="Enter first name" value="${passengerData[i].firstName}" onchange="updatePassengerData(${i}, 'firstName', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="passenger${i}_lastName">Last Name</label>
                            <input type="text" id="passenger${i}_lastName" name="passenger${i}_lastName" placeholder="Enter last name" value="${passengerData[i].lastName}" onchange="updatePassengerData(${i}, 'lastName', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="passenger${i}_idNumber">ID Number</label>
                            <input type="text" id="passenger${i}_idNumber" name="passenger${i}_idNumber" placeholder="Enter ID number" value="${passengerData[i].idNumber}" onchange="updatePassengerData(${i}, 'idNumber', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="passenger${i}_phone">Phone Number</label>
                            <input type="tel" id="passenger${i}_phone" name="passenger${i}_phone" placeholder="Enter phone number" value="${passengerData[i].phone}" onchange="updatePassengerData(${i}, 'phone', this.value)">
                        </div>
                    </div>
                `;
                passengerForms.appendChild(passengerCard);
            }
        }

        function updatePassengerData(passengerIndex, field, value) {
            if (!passengerData[passengerIndex]) {
                passengerData[passengerIndex] = {
                    firstName: '',
                    lastName: '',
                    idNumber: '',
                    phone: ''
                };
            }
            passengerData[passengerIndex][field] = value;
        }

        function addPassenger() {
            if (currentPassengerCount < maxPassengers) {
                currentPassengerCount++;
                // Initialize data for the new passenger
                passengerData[currentPassengerCount] = {
                    firstName: '',
                    lastName: '',
                    idNumber: '',
                    phone: ''
                };
                updateCapacityInfo();
                generatePassengerForms();
                updateAddPassengerButton();
            }
        }

        function removePassenger(passengerNumber) {
            if (currentPassengerCount > 1) {
                // Remove the passenger data
                delete passengerData[passengerNumber];
                
                // Shift remaining passenger data down
                const newPassengerData = {};
                let newIndex = 1;
                for (let i = 1; i <= currentPassengerCount; i++) {
                    if (passengerData[i] && i !== passengerNumber) {
                        newPassengerData[newIndex] = passengerData[i];
                        newIndex++;
                    }
                }
                passengerData = newPassengerData;
                
                currentPassengerCount--;
                updateCapacityInfo();
                generatePassengerForms();
                updateAddPassengerButton();
            }
        }

        function updateAddPassengerButton() {
            const addPassengerSection = document.getElementById('addPassengerSection');
            console.log('Updating add passenger button...'); // Debug log
            console.log('Current passenger count:', currentPassengerCount); // Debug log
            console.log('Max passengers:', maxPassengers); // Debug log
            console.log('Should show button:', currentPassengerCount < maxPassengers); // Debug log
            
            if (currentPassengerCount < maxPassengers) {
                addPassengerSection.style.display = 'block';
                console.log('Showing add passenger button'); // Debug log
            } else {
                addPassengerSection.style.display = 'none';
                console.log('Hiding add passenger button'); // Debug log
            }
        }

        function savePassengers() {
            // Collect passenger data
            const passengers = [];
            for (let i = 1; i <= currentPassengerCount; i++) {
                if (passengerData[i]) {
                    const { firstName, lastName, idNumber, phone } = passengerData[i];
                    if (firstName || lastName || idNumber || phone) {
                        passengers.push({
                            firstName: firstName,
                            lastName: lastName,
                            idNumber: idNumber,
                            phone: phone
                        });
                    }
                }
            }
            
            // Update the booking with new passenger data
            currentBooking.passengers = passengers;
            
            // Save to appropriate storage based on booking status
            const bookingStatus = sessionStorage.getItem('currentBookingStatus');
            const bookingId = sessionStorage.getItem('currentBookingId');
            
            if (bookingStatus === 'pending') {
                const pendingBookings = JSON.parse(localStorage.getItem('pendingBookings') || '[]');
                const bookingIndex = pendingBookings.findIndex(b => b.id === bookingId);
                if (bookingIndex !== -1) {
                    pendingBookings[bookingIndex] = currentBooking;
                    localStorage.setItem('pendingBookings', JSON.stringify(pendingBookings));
                }
            } else if (bookingStatus === 'confirmed') {
                const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                const bookingIndex = confirmedBookings.findIndex(b => b.id === bookingId);
                if (bookingIndex !== -1) {
                    confirmedBookings[bookingIndex] = currentBooking;
                    localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                }
            }
            
            alert('Passenger information saved successfully!');
            window.location.href = 'booking-trip-info.html';
        }

        function goBack() {
            window.location.href = 'booking-trip-info.html';
        }
    </script>
</body>
</html>
